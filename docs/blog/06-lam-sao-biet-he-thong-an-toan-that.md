# ğŸ§ª LÃ m Sao Biáº¿t Há»‡ Thá»‘ng An ToÃ n Tháº­t â€” Chá»© KhÃ´ng Chá»‰ "Tháº¥y Cháº¡y ÄÆ°á»£c"?

> *BÃ i #6 trong chuá»—i AegisOS â€” dÃ nh cho báº¡n nhá» mÆ¡ lÃ m ká»¹ sÆ°. HÃ´m nay: Testing â€” nghá»‡ thuáº­t tÃ¬m lá»—i trÆ°á»›c khi lá»—i tÃ¬m ra ngÆ°á»i.*

---

## ğŸš€ Giáº¥c MÆ¡ TÆ°Æ¡ng Lai

NÄƒm 2041. Em lÃ  ká»¹ sÆ° pháº§n má»m cho má»™t cÃ´ng ty tÃªn lá»­a.

TÃªn lá»­a cá»§a em sáº¯p Ä‘Æ°a 4 nhÃ  du hÃ nh lÃªn tráº¡m vÅ© trá»¥. BÃªn trong tÃªn lá»­a cÃ³ hÃ ng chá»¥c chÆ°Æ¡ng trÃ¬nh cháº¡y cÃ¹ng lÃºc: Ä‘iá»u khiá»ƒn Ä‘á»™ng cÆ¡, tÃ­nh quá»¹ Ä‘áº¡o, giÃ¡m sÃ¡t nhiÃªn liá»‡u, liÃªn láº¡c máº·t Ä‘áº¥t...

Äáº¿n ngÃ y phÃ³ng. Em Ä‘á»©ng trong phÃ²ng Ä‘iá»u khiá»ƒn. Äáº¿m ngÆ°á»£c.

*10... 9... 8...*

Bá»—ng sáº¿p quay sang há»i em:

> *"Em cÃ³ **cháº¯c cháº¯n** pháº§n má»m khÃ´ng cÃ³ lá»—i khÃ´ng?"*

Em tráº£ lá»i gÃ¬?

- **"Dáº¡, em Ä‘Ã£ cháº¡y thá»­ trÃªn mÃ¡y tÃ­nh, tháº¥y cháº¡y Ä‘Æ°á»£c áº¡"** â€” ğŸ˜¬
- **"Dáº¡, em Ä‘Ã£ viáº¿t 55 bÃ i kiá»ƒm tra tá»± Ä‘á»™ng, táº¥t cáº£ Ä‘á»u Ä‘áº¡t. Robot kiá»ƒm tra láº¡i má»—i láº§n em sá»­a code. VÃ  em cÃ³ báº±ng chá»©ng"** â€” ğŸ˜Š

Sáº¿p sáº½ tin cÃ¢u tráº£ lá»i nÃ o hÆ¡n?

*3... 2... 1... PhÃ³ng!*

Bá»‘n máº¡ng ngÆ°á»i trÃªn Ä‘Ã³. CÃ¢u tráº£ lá»i cá»§a em pháº£i lÃ  cÃ¢u thá»© hai.

**NhÆ°ng "55 bÃ i kiá»ƒm tra tá»± Ä‘á»™ng" lÃ  gÃ¬? "Robot kiá»ƒm tra" lÃ  gÃ¬? "Báº±ng chá»©ng" lÃ  gÃ¬?**

HÃ´m nay, chÃºng ta sáº½ xÃ¢y táº¥t cáº£ nhá»¯ng thá»© Ä‘Ã³ cho AegisOS.

---

## ğŸ« BÃ i Kiá»ƒm Tra á» TrÆ°á»ng

### Táº¡i sao pháº£i kiá»ƒm tra?

Em nghÄ© thá»­ nhÃ©: táº¡i sao á»Ÿ trÆ°á»ng pháº£i cÃ³ **bÃ i kiá»ƒm tra**?

KhÃ´ng pháº£i Ä‘á»ƒ hÃ nh háº¡ há»c sinh Ä‘Ã¢u! MÃ  vÃ¬:

1. **Äá»ƒ biáº¿t em Ä‘Ã£ hiá»ƒu bÃ i chÆ°a** â€” náº¿u sai, cÃ´ giÃ¡o sáº½ giÃºp em sá»­a
2. **Äá»ƒ phÃ¡t hiá»‡n lá»— há»•ng** â€” cÃ³ thá»ƒ em hiá»ƒu 90% nhÆ°ng sÃ³t 10% quan trá»ng
3. **Äá»ƒ cÃ³ báº±ng chá»©ng** â€” khi nÃ o cáº§n, em chá»‰ ra "Ä‘Ã¢y, con Ä‘Ã£ Ä‘áº¡t Ä‘iá»ƒm nÃ y"

Pháº§n má»m cÅ©ng váº­y!

| á» trÆ°á»ng | Trong pháº§n má»m |
|---|---|
| BÃ i kiá»ƒm tra ToÃ¡n | **Unit test** â€” kiá»ƒm tra tá»«ng pháº§n nhá» |
| BÃ i thi cuá»‘i ká»³ (tá»•ng há»£p nhiá»u mÃ´n) | **Integration test** â€” kiá»ƒm tra cáº£ há»‡ thá»‘ng cháº¡y cÃ¹ng nhau |
| CÃ´ giÃ¡o cháº¥m bÃ i | **Test framework** â€” chÆ°Æ¡ng trÃ¬nh tá»± Ä‘á»™ng cháº¥m Ä‘iá»ƒm |
| Kiá»ƒm tra báº¥t chá»£t (15 phÃºt) | **CI (Continuous Integration)** â€” robot tá»± kiá»ƒm tra má»—i láº§n sá»­a code |
| Sá»• Ä‘iá»ƒm ghi káº¿t quáº£ | **Test report** â€” báº±ng chá»©ng táº¥t cáº£ bÃ i Ä‘á»u Ä‘áº¡t |

### NhÆ°ng cÃ³ khÃ¡c nhau má»™t chá»— ráº¥t quan trá»ng

á» trÆ°á»ng, náº¿u em lÃ m sai bÃ i kiá»ƒm tra â€” em bá»‹ Ä‘iá»ƒm tháº¥p. Buá»“n, nhÆ°ng khÃ´ng ai bá»‹ thÆ°Æ¡ng.

Trong pháº§n má»m an toÃ n â€” náº¿u "bÃ i kiá»ƒm tra" bá»‹ bá» qua, vÃ  lá»—i lá»t ra ngoÃ i â€” **ngÆ°á»i ta cÃ³ thá»ƒ cháº¿t**.

VÃ¬ váº­y, ngÃ nh hÃ ng khÃ´ng, y táº¿, Ã´ tÃ´ cÃ³ nhá»¯ng tiÃªu chuáº©n ráº¥t nghiÃªm ngáº·t:

- **DO-178C** (mÃ¡y bay) â€” yÃªu cáº§u pháº£i cÃ³ **báº±ng chá»©ng kiá»ƒm thá»­** trÆ°á»›c khi pháº§n má»m Ä‘Æ°á»£c phÃ©p bay
- **IEC 62304** (thiáº¿t bá»‹ y táº¿) â€” yÃªu cáº§u **kiá»ƒm tra tá»± Ä‘á»™ng, láº·p láº¡i Ä‘Æ°á»£c**
- **ISO 26262** (Ã´ tÃ´) â€” yÃªu cáº§u cáº£ **unit test** láº«n **integration test**

Táº¥t cáº£ Ä‘á»u nÃ³i má»™t Ä‘iá»u: **"Cháº¡y thá»­ tháº¥y Ä‘Æ°á»£c" lÃ  chÆ°a Ä‘á»§. Pháº£i cÃ³ báº±ng chá»©ng.**

---

## ğŸ” Váº¥n Äá» Cá»§a AegisOS: KhÃ´ng CÃ³ BÃ i Kiá»ƒm Tra NÃ o

TrÆ°á»›c Phase F, AegisOS Ä‘Ã£ cÃ³ ráº¥t nhiá»u thá»© tuyá»‡t vá»i:
- âœ… Khá»Ÿi Ä‘á»™ng tá»« con sá»‘ 0 (Phase A)
- âœ… Báº£o vá»‡ bá»™ nhá»› W^X (Phase B)
- âœ… Cháº¡y 3 task cÃ¹ng lÃºc + IPC (Phase C)
- âœ… TÃ¡ch kernel/user, EL0 isolation (Phase D)
- âœ… CÃ´ láº­p lá»—i, auto-restart (Phase E)

NhÆ°ng **khÃ´ng cÃ³ má»™t bÃ i kiá»ƒm tra tá»± Ä‘á»™ng nÃ o**.

Muá»‘n biáº¿t kernel cÃ³ cháº¡y khÃ´ng? Pháº£i tá»± gÃµ lá»‡nh, má»Ÿ QEMU, Ä‘á»c output báº±ng máº¯t. Má»—i. Má»™t. Láº§n.

Giá»‘ng nhÆ° má»—i láº§n lÃ m xong bÃ i, em khÃ´ng kiá»ƒm tra láº¡i, cá»© ná»™p luÃ´n. May thÃ¬ Ä‘Ãºng. KhÃ´ng may thÃ¬ sai mÃ  khÃ´ng biáº¿t.

Vá»›i ~2.000 dÃ²ng code, má»™t thay Ä‘á»•i nhá» á»Ÿ file nÃ y cÃ³ thá»ƒ **break** file kia â€” mÃ  khÃ´ng ai phÃ¡t hiá»‡n cho Ä‘áº¿n khi cháº¡y QEMU thá»§ cÃ´ng.

ÄÃ³ lÃ  lÃ½ do Phase F ra Ä‘á»i: **xÃ¢y há»‡ thá»‘ng kiá»ƒm tra tá»± Ä‘á»™ng**.

---

## ğŸ§© Hai Loáº¡i Kiá»ƒm Tra

### Loáº¡i 1: Unit Test â€” Kiá»ƒm tra tá»«ng viÃªn gáº¡ch

HÃ£y tÆ°á»Ÿng tÆ°á»£ng em Ä‘ang xÃ¢y má»™t ngÃ´i nhÃ  báº±ng LEGO.

TrÆ°á»›c khi ghÃ©p cáº£ ngÃ´i nhÃ , em sáº½ **kiá»ƒm tra tá»«ng viÃªn gáº¡ch**:
- ViÃªn nÃ y cÃ³ Ä‘Ãºng kÃ­ch thÆ°á»›c khÃ´ng?
- ViÃªn kia cÃ³ khá»›p vá»›i viÃªn bÃªn cáº¡nh khÃ´ng?
- ViÃªn ná»n cÃ³ Ä‘á»§ cá»©ng Ä‘á»ƒ chá»‹u Ä‘Æ°á»£c táº§ng 2 khÃ´ng?

Trong AegisOS, "viÃªn gáº¡ch" lÃ  cÃ¡c **hÃ m** (function) â€” nhá»¯ng Ä‘oáº¡n code nhá» lÃ m má»™t viá»‡c cá»¥ thá»ƒ.

VÃ­ dá»¥, hÃ m `validate_write_args` kiá»ƒm tra xem task cÃ³ quyá»n ghi vÃ o má»™t Ä‘á»‹a chá»‰ bá»™ nhá»› khÃ´ng. ÄÃ¢y lÃ  hÃ m **cá»±c ká»³ quan trá»ng** â€” náº¿u nÃ³ sai, task cÃ³ thá»ƒ ghi Ä‘Ã¨ lÃªn UART, lÃªn kernel, lÃªn báº¥t cá»© Ä‘Ã¢u!

Váº­y chÃºng ta viáº¿t bÃ i kiá»ƒm tra cho nÃ³:

| TÃ¬nh huá»‘ng | Äáº§u vÃ o | Káº¿t quáº£ Ä‘Ãºng |
|---|---|---|
| Äá»‹a chá»‰ náº±m trong RAM | `0x4008_0000`, 10 byte | âœ… Cho phÃ©p |
| Äá»‹a chá»‰ = 0 (null) | `0x0`, 10 byte | âŒ Tá»« chá»‘i |
| Äá»‹a chá»‰ lÃ  UART (thiáº¿t bá»‹!) | `0x0900_0000`, 1 byte | âŒ Tá»« chá»‘i |
| Äá»™ dÃ i = 0 | `0x4008_0000`, 0 byte | âŒ Tá»« chá»‘i |
| Äá»™ dÃ i quÃ¡ lá»›n (> 256) | `0x4008_0000`, 257 byte | âŒ Tá»« chá»‘i |
| Äá»‹a chá»‰ + Ä‘á»™ dÃ i trÃ n ra ngoÃ i RAM | `0x47FF_FF01`, 256 byte | âŒ Tá»« chá»‘i |

12 bÃ i kiá»ƒm tra chá»‰ cho **má»™t** hÃ m duy nháº¥t! Má»—i bÃ i kiá»ƒm tra má»™t **tÃ¬nh huá»‘ng ranh giá»›i** â€” nÆ¡i lá»—i hay áº©n náº¥p nháº¥t.

NhÆ°ng vÃ¬ AegisOS cháº¡y trÃªn ARM (AArch64) â€” má»™t loáº¡i CPU mÃ  laptop em khÃ´ng cÃ³ â€” nÃªn lÃ m sao kiá»ƒm tra Ä‘Æ°á»£c?

### BÃ­ quyáº¿t: TÃ¡ch "bá»™ nÃ£o" ra khá»i "cÆ¡ thá»ƒ"

ÄÃ¢y lÃ  Ã½ tÆ°á»Ÿng thÃ´ng minh nháº¥t cá»§a Phase F.

Trong kernel, cÃ³ hai loáº¡i code:

1. **Code phá»¥ thuá»™c pháº§n cá»©ng** â€” chá»‰ cháº¡y Ä‘Æ°á»£c trÃªn CPU AArch64 tháº­t (hoáº·c QEMU giáº£ láº­p). VÃ­ dá»¥: ghi vÃ o UART, cÃ i Ä‘áº·t báº£ng trang, lá»‡nh `eret` nháº£y vÃ o EL0.

2. **Code logic thuáº§n** â€” chá»‰ lÃ  toÃ¡n há»c vÃ  quy táº¯c, cháº¡y Ä‘Æ°á»£c á»Ÿ **báº¥t ká»³ Ä‘Ã¢u**. VÃ­ dá»¥: "task tiáº¿p theo trong round-robin lÃ  ai?", "con trá» nÃ y cÃ³ náº±m trong RAM khÃ´ng?", "bit thá»© 53 cá»§a descriptor cÃ³ báº­t khÃ´ng?"

ChÃºng ta **tÃ¡ch** pháº§n logic thuáº§n ra, rá»“i kiá»ƒm tra nÃ³ trÃªn **mÃ¡y tÃ­nh cá»§a mÃ¬nh** (x86_64 â€” loáº¡i CPU trong laptop em). KhÃ´ng cáº§n QEMU, khÃ´ng cáº§n pháº§n cá»©ng ARM.

Giá»‘ng nhÆ°: muá»‘n kiá»ƒm tra má»™t **cÃ´ng thá»©c ToÃ¡n** cÃ³ Ä‘Ãºng khÃ´ng â€” em khÃ´ng cáº§n bay lÃªn tÃ u vÅ© trá»¥ Ä‘á»ƒ thá»­. Em ngá»“i á»Ÿ bÃ n há»c, tháº¿ vÃ i sá»‘ vÃ o, tÃ­nh ra káº¿t quáº£, rá»“i so vá»›i Ä‘Ã¡p Ã¡n.

Trong AegisOS, chÃºng ta dÃ¹ng má»™t ká»¹ thuáº­t gá»i lÃ  **cfg gate** â€” giá»‘ng nhÆ° má»™t cÃ¡nh cá»­a cÃ³ á»• khÃ³a:

| Pháº§n code | TrÃªn AArch64 (kernel tháº­t) | TrÃªn x86_64 (mÃ¡y em) |
|---|---|---|
| Ghi vÃ o UART | âœ… Ghi tháº­t qua MMIO | ğŸš« KhÃ´ng lÃ m gÃ¬ (no-op) |
| Lá»‡nh assembly (`asm!`) | âœ… Cháº¡y lá»‡nh ARM | ğŸš« Bá»‹ áº©n Ä‘i báº±ng `#[cfg]` |
| Linker symbol (`__stack_end`) | âœ… CÃ³ tháº­t trong bá»™ nhá»› | ğŸš« Bá»‹ áº©n Ä‘i |
| HÃ m `validate_write_args` | âœ… Cháº¡y bÃ¬nh thÆ°á»ng | âœ… Cháº¡y bÃ¬nh thÆ°á»ng! |
| HÃ m `schedule` (logic round-robin) | âœ… Cháº¡y bÃ¬nh thÆ°á»ng | âœ… Cháº¡y bÃ¬nh thÆ°á»ng! |
| Háº±ng sá»‘ MMU (`AP_RW_EL0`, `PXN`...) | âœ… DÃ¹ng Ä‘á»ƒ cÃ i báº£ng trang | âœ… Kiá»ƒm tra giÃ¡ trá»‹ bit! |

Káº¿t quáº£? **55 bÃ i kiá»ƒm tra** cháº¡y ngay trÃªn laptop, trong **0.03 giÃ¢y**. KhÃ´ng cáº§n QEMU.

### Loáº¡i 2: Integration Test â€” Kiá»ƒm tra cáº£ ngÃ´i nhÃ 

Kiá»ƒm tra tá»«ng viÃªn gáº¡ch xong, em pháº£i **ghÃ©p cáº£ ngÃ´i nhÃ ** rá»“i thá»­ xem nÃ³ cÃ³ Ä‘á»©ng vá»¯ng khÃ´ng.

Vá»›i AegisOS, "ghÃ©p cáº£ ngÃ´i nhÃ " nghÄ©a lÃ : **build kernel tháº­t â†’ cháº¡y trÃªn QEMU â†’ xem output UART**.

ChÃºng ta viáº¿t má»™t **script** â€” má»™t danh sÃ¡ch hÆ°á»›ng dáº«n cho mÃ¡y tÃ­nh:

1. Build kernel cho AArch64
2. Má»Ÿ QEMU, cháº¡y kernel, Ä‘á»£i 15 giÃ¢y
3. Báº¯t láº¡i táº¥t cáº£ chá»¯ mÃ  kernel in ra
4. Kiá»ƒm tra: cÃ³ tháº¥y dÃ²ng **"[AegisOS] boot"** khÃ´ng? CÃ³ tháº¥y **"A:PING"** khÃ´ng? CÃ³ tháº¥y **"B:PONG"** khÃ´ng?

8 checkpoint. Náº¿u thiáº¿u báº¥t ká»³ dÃ²ng nÃ o â†’ **FAIL**.

Giá»‘ng nhÆ° khi cÃ´ giÃ¡o kiá»ƒm tra bÃ i táº­p nhÃ³m:
- âœ… CÃ³ bÃ¬a? âœ… CÃ³ má»¥c lá»¥c? âœ… CÃ³ ná»™i dung? âœ… CÃ³ káº¿t luáº­n?
- Thiáº¿u má»™t pháº§n â†’ pháº£i lÃ m láº¡i.

---

## ğŸ¤– Robot Kiá»ƒm Tra â€” CI LÃ  GÃ¬?

Äáº¿n pháº§n hay nháº¥t.

Em Ä‘Ã£ cÃ³ 55 unit test + 8 integration checkpoint. NhÆ°ng náº¿u **em quÃªn cháº¡y** chÃºng thÃ¬ sao?

Con ngÆ°á»i hay quÃªn. MÃ¡y tÃ­nh thÃ¬ khÃ´ng.

VÃ¬ váº­y chÃºng ta táº¡o má»™t **robot kiá»ƒm tra** tÃªn lÃ  **CI** â€” viáº¿t táº¯t cá»§a **Continuous Integration** (tÃ­ch há»£p liÃªn tá»¥c).

CI hoáº¡t Ä‘á»™ng tháº¿ nÃ y:

1. Em sá»­a code rá»“i **push** (gá»­i) lÃªn GitHub
2. Robot CI **tá»± Ä‘á»™ng thá»©c dáº­y**
3. Robot táº£i code má»›i nháº¥t
4. Robot cÃ i Rust + QEMU
5. Robot cháº¡y **55 unit test** â†’ Táº¥t cáº£ pass? âœ…
6. Robot build kernel + cháº¡y trÃªn QEMU â†’ 8 checkpoint pass? âœ…
7. Robot bÃ¡o cÃ¡o: **"Xanh lÃ¡! Má»i thá»© á»•n!"** ğŸŸ¢

Náº¿u cÃ³ gÃ¬ sai? Robot hÃ©t lÃªn: **"Äá»! BÃ i kiá»ƒm tra X bá»‹ fail!"** ğŸ”´

| Äá»i tháº­t | CI |
|---|---|
| CÃ´ giÃ¡o kiá»ƒm tra bÃ i má»—i buá»•i sÃ¡ng | Robot cháº¡y test má»—i láº§n push code |
| CÃ´ giÃ¡o Ä‘Ã¡nh dáº¥u bÃ i sai báº±ng bÃºt Ä‘á» | Robot hiá»‡n âŒ bÃªn cáº¡nh test fail |
| Sá»• liÃªn láº¡c ghi "con ngoan" | Badge xanh ğŸŸ¢ trÃªn GitHub |
| CÃ´ giÃ¡o nghá»‰ phÃ©p â†’ khÃ´ng ai cháº¥m | Robot **khÃ´ng bao giá» nghá»‰** |

Trong AegisOS, robot CI cháº¡y trÃªn **GitHub Actions** â€” má»™t dá»‹ch vá»¥ miá»…n phÃ­ cá»§a GitHub. Má»—i khi cÃ³ code má»›i, GitHub tá»± Ä‘á»™ng báº­t má»™t mÃ¡y tÃ­nh Linux trÃªn cloud, cÃ i Ä‘áº·t má»i thá»©, cháº¡y test, rá»“i bÃ¡o káº¿t quáº£.

---

## ğŸ—ï¸ AegisOS ÄÃ£ LÃ m ÄÆ°á»£c GÃ¬?

### ThÃ¡ch thá»©c #1: Code kernel khÃ´ng cháº¡y Ä‘Æ°á»£c trÃªn laptop

AegisOS viáº¿t cho CPU ARM. Laptop dÃ¹ng CPU x86. KhÃ¡c nhau hoÃ n toÃ n â€” giá»‘ng nhÆ° sÃ¡ch Tiáº¿ng Viá»‡t vÃ  sÃ¡ch Tiáº¿ng Nháº­t, khÃ´ng Ä‘á»c láº«n cho nhau Ä‘Æ°á»£c.

**Giáº£i phÃ¡p:** ChÃºng ta chia code thÃ nh **hai pháº§n**:
- [src/lib.rs](src/lib.rs) â€” thÆ° viá»‡n chung, chá»©a táº¥t cáº£ module. Khi build cho ARM, má»i thá»© hoáº¡t Ä‘á»™ng. Khi build cho x86, chá»‰ pháº§n logic thuáº§n Ä‘Æ°á»£c báº­t.
- [src/main.rs](src/main.rs) â€” file khá»Ÿi Ä‘á»™ng kernel, chá»©a toÃ n bá»™ code ARM. Khi test trÃªn x86, file nÃ y bá»‹ "táº¯t" hoÃ n toÃ n â€” nÃ³ chá»‰ cÃ²n lÃ  má»™t hÃ m `main()` trá»‘ng rá»—ng.

Module [src/gic.rs](src/gic.rs) (bá»™ Ä‘iá»u khiá»ƒn ngáº¯t â€” hoÃ n toÃ n pháº§n cá»©ng) Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u `#[cfg(target_arch = "aarch64")]` â€” chá»‰ tá»“n táº¡i trÃªn ARM.

### ThÃ¡ch thá»©c #2: Biáº¿n toÃ n cá»¥c (`static mut`)

AegisOS khÃ´ng cÃ³ **heap** (vÃ¹ng nhá»› Ä‘á»™ng). Má»i dá»¯ liá»‡u Ä‘á»u lÃ  biáº¿n toÃ n cá»¥c: `TCBS` (báº£ng task), `ENDPOINTS` (há»™p thÆ° IPC), `TICK_COUNT` (bá»™ Ä‘áº¿m thá»i gian)...

Váº¥n Ä‘á»: náº¿u cháº¡y nhiá»u bÃ i test cÃ¹ng lÃºc, chÃºng sáº½ **ghi Ä‘Ã¨ lÃªn nhau** â€” test A thay Ä‘á»•i `TCBS`, rá»“i test B Ä‘á»c `TCBS` Ä‘Ã£ bá»‹ thay Ä‘á»•i â†’ káº¿t quáº£ sai!

**Giáº£i phÃ¡p:**
- Má»—i bÃ i test gá»i hÃ m `reset_test_state()` Ä‘á»ƒ **dá»n sáº¡ch** má»i biáº¿n toÃ n cá»¥c trÆ°á»›c khi báº¯t Ä‘áº§u
- Cháº¡y test vá»›i `--test-threads=1` â€” chá»‰ má»™t test cháº¡y táº¡i má»™t thá»i Ä‘iá»ƒm, giá»‘ng nhÆ° xáº¿p hÃ ng vÃ o nhÃ  vá»‡ sinh â€” má»—i láº§n má»™t ngÆ°á»i

### ThÃ¡ch thá»©c #3: Hai "ngÃ´n ngá»¯" build khÃ¡c nhau

Khi build kernel cho ARM, Rust cáº§n thÃªm cá» Ä‘áº·c biá»‡t: `-Zbuild-std=core` (build láº¡i thÆ° viá»‡n lÃµi tá»« mÃ£ nguá»“n). NhÆ°ng khi cháº¡y test trÃªn x86, cá» nÃ y **gÃ¢y xung Ä‘á»™t** â€” mÃ¡y tÃ­nh bá»‹ nháº§m láº«n giá»¯a hai báº£n thÆ° viá»‡n.

**Giáº£i phÃ¡p:** Chuyá»ƒn cá» Ä‘áº·c biá»‡t ra **dÃ²ng lá»‡nh** thay vÃ¬ Ä‘áº·t trong file cáº¥u hÃ¬nh. Khi build kernel â†’ thÃªm cá». Khi cháº¡y test â†’ khÃ´ng thÃªm.

### Káº¿t quáº£: 55 test, 0 fail, 0.03 giÃ¢y

```
running 55 tests
test trapframe_size_is_288           ... ok
test mmu_device_block_is_non_executable ... ok
test validate_write_uart_mmio        ... ok
test sched_round_robin_all_ready     ... ok
test ipc_copy_message                ... ok
...
test result: ok. 55 passed; 0 failed
```

| NhÃ³m test | Sá»‘ bÃ i | Kiá»ƒm tra cÃ¡i gÃ¬ |
|---|---|---|
| **TrapFrame** | 4 | KÃ­ch thÆ°á»›c = 288 byte, offset cÃ¡c trÆ°á»ng khá»›p assembly |
| **MMU descriptors** | 18 | Bit Ä‘Ãºng vá»‹ trÃ­, W^X (ghi â†” thá»±c thi loáº¡i trá»« nhau) |
| **SYS_WRITE** | 12 | Tá»« chá»‘i pointer láº¡, cháº¥p nháº­n pointer trong RAM |
| **Scheduler** | 11 | Round-robin Ä‘Ãºng thá»© tá»±, bá» qua task lá»—i, auto-restart |
| **IPC** | 10 | Gá»­i/nháº­n Ä‘Ãºng, dá»n dáº¹p khi task crash |
| **Tá»•ng** | **55** | ğŸ¯ |

---

## ğŸ“ Táº¡i Sao 288 Byte Quan Trá»ng Äáº¿n Váº­y?

Pháº§n nÃ y hÆ¡i khÃ³, nhÆ°ng em cá»© Ä‘á»c cháº­m láº¡i nhÃ©.

Khi má»™t task bá»‹ ngáº¯t (interrupt), kernel pháº£i **lÆ°u láº¡i toÃ n bá»™ tráº¡ng thÃ¡i** cá»§a task Ä‘Ã³ â€” 31 thanh ghi (register), Ä‘á»‹a chá»‰ Ä‘ang cháº¡y, tráº¡ng thÃ¡i CPU... Táº¥t cáº£ náº±m trong má»™t "há»™p" gá»i lÃ  **TrapFrame**.

TrapFrame cÃ³ kÃ­ch thÆ°á»›c **chÃ­nh xÃ¡c 288 byte**. KhÃ´ng hÆ¡n. KhÃ´ng kÃ©m.

Táº¡i sao pháº£i chÃ­nh xÃ¡c? VÃ¬ TrapFrame Ä‘Æ°á»£c dÃ¹ng bá»Ÿi **hai ngÃ´n ngá»¯ khÃ¡c nhau**:
- **Rust** â€” dÃ¹ng struct Ä‘á»ƒ Ä‘á»c/ghi tá»«ng trÆ°á»ng
- **Assembly** â€” dÃ¹ng offset (vá»‹ trÃ­ byte) cá»‘ Ä‘á»‹nh Ä‘á»ƒ lÆ°u/khÃ´i phá»¥c thanh ghi

Náº¿u Rust nÃ³i "thanh ghi x[30] á»Ÿ byte thá»© 240" mÃ  Assembly nÃ³i "á»Ÿ byte thá»© 248" â€” khi kernel khÃ´i phá»¥c tráº¡ng thÃ¡i, task sáº½ nháº£y vá» **sai Ä‘á»‹a chá»‰**. Kernel crash. Táº¥t cáº£ task cháº¿t.

VÃ¬ váº­y, bÃ i test Ä‘áº§u tiÃªn chÃºng ta viáº¿t lÃ :

> **KÃ­ch thÆ°á»›c TrapFrame cÃ³ Ä‘Ãºng 288 byte khÃ´ng?**
> **TrÆ°á»ng `elr_el1` (Ä‘á»‹a chá»‰ tráº£ vá») cÃ³ náº±m á»Ÿ offset 256 khÃ´ng?**
> **TrÆ°á»ng `sp_el0` (stack pointer) cÃ³ náº±m á»Ÿ offset 248 khÃ´ng?**

Náº¿u ai Ä‘Ã³ **vÃ´ tÃ¬nh thÃªm má»™t trÆ°á»ng** vÃ o TrapFrame, hoáº·c **Ä‘á»•i thá»© tá»±** â€” bÃ i test sáº½ **láº­p tá»©c fail**. TrÆ°á»›c khi code ká»‹p lÃªn tÃ u vÅ© trá»¥.

ÄÃ¢y gá»i lÃ  **ABI lock** â€” khÃ³a giao diá»‡n nhá»‹ phÃ¢n. Giá»‘ng nhÆ° báº£n váº½ ká»¹ thuáº­t cá»§a á»• khÃ³a: náº¿u ai Ä‘á»•i kÃ­ch thÆ°á»›c lá»— khÃ³a dÃ¹ chá»‰ 0.1mm, chÃ¬a khÃ³a khÃ´ng xoay Ä‘Æ°á»£c ná»¯a.

---

## ğŸ›¡ï¸ W^X: Kiá»ƒm Tra Quy Táº¯c "Ghi Hoáº·c Cháº¡y, KhÃ´ng Cáº£ Hai"

Nhá»› quy táº¯c **W^X** (Write XOR Execute) tá»« bÃ i #2 khÃ´ng?

Má»™t vÃ¹ng bá»™ nhá»› chá»‰ Ä‘Æ°á»£c phÃ©p:
- **Ghi** (chá»©a dá»¯ liá»‡u) â€” nhÆ°ng **khÃ´ng Ä‘Æ°á»£c cháº¡y** code tá»« Ä‘Ã³
- **Cháº¡y** (chá»©a code) â€” nhÆ°ng **khÃ´ng Ä‘Æ°á»£c ghi** vÃ o Ä‘Ã³

Äiá»u nÃ y ngÄƒn hacker nhÃ©t code Ä‘á»™c vÃ o vÃ¹ng dá»¯ liá»‡u rá»“i báº£o CPU cháº¡y nÃ³.

Trong AegisOS, quy táº¯c nÃ y Ä‘Æ°á»£c mÃ£ hÃ³a báº±ng **bit** trong cÃ¡c descriptor (bá»™ mÃ´ táº£ trang bá»™ nhá»›). ChÃºng ta viáº¿t test Ä‘á»ƒ kiá»ƒm tra:

| Loáº¡i trang | Ghi Ä‘Æ°á»£c? | Cháº¡y Ä‘Æ°á»£c? | Test kiá»ƒm tra gÃ¬ |
|---|---|---|---|
| **Kernel data** | âœ… | âŒ | CÃ³ bit PXN + UXN (khÃ´ng ai cháº¡y) |
| **User data** | âœ… | âŒ | CÃ³ bit PXN + UXN |
| **Shared code** | âŒ (read-only) | âœ… | KhÃ´ng cÃ³ PXN, khÃ´ng cÃ³ UXN |
| **Device (UART)** | âœ… (chá»‰ kernel) | âŒ | CÃ³ bit XN, AP = chá»‰ EL1 |

18 bÃ i test, kiá»ƒm tra **tá»«ng bit** cá»§a tá»«ng loáº¡i trang. Náº¿u ai Ä‘Ã³ sá»­a constant mÃ  quÃªn báº­t bit XN â€” test fail ngay.

---

## âœ¨ Táº¡i Sao Em NÃªn Quan TÃ¢m?

Em biáº¿t **Margaret Hamilton** khÃ´ng? (BÃ  Ä‘Ã£ xuáº¥t hiá»‡n á»Ÿ bÃ i trÆ°á»›c!)

Khi bÃ  viáº¿t pháº§n má»m cho Apollo 11, bÃ  khÃ´ng chá»‰ viáº¿t code â€” bÃ  viáº¿t ráº¥t nhiá»u **test**. VÃ  bÃ  kiÃªn quyáº¿t ráº±ng pháº§n má»m pháº£i Ä‘Æ°á»£c kiá»ƒm tra **má»i tÃ¬nh huá»‘ng cÃ³ thá»ƒ xáº£y ra**, ká»ƒ cáº£ nhá»¯ng tÃ¬nh huá»‘ng "khÃ´ng bao giá» xáº£y ra" (mÃ  cuá»‘i cÃ¹ng láº¡i xáº£y ra trÃªn Máº·t TrÄƒng!).

Sau Apollo, tháº¿ giá»›i há»c Ä‘Æ°á»£c ráº±ng:

> **Code mÃ  khÃ´ng cÃ³ test â€” giá»‘ng nhÆ° cáº§u mÃ  khÃ´ng ai kiá»ƒm tra trÆ°á»›c khi cho xe cháº¡y.**

NgÃ y nay, má»i cÃ´ng ty lá»›n â€” Google, Apple, SpaceX, Tesla â€” Ä‘á»u yÃªu cáº§u **má»—i dÃ²ng code pháº£i cÃ³ test Ä‘i kÃ¨m**. KhÃ´ng cÃ³ test, code khÃ´ng Ä‘Æ°á»£c merge (ghÃ©p vÃ o dá»± Ã¡n chÃ­nh).

VÃ  bÃ¢y giá», AegisOS nhá» bÃ© cÅ©ng cÃ³ há»‡ thá»‘ng test â€” giá»‘ng y há»‡t nguyÃªn táº¯c mÃ  SpaceX dÃ¹ng cho Falcon 9.

---

## ğŸ”® BÆ°á»›c Tiáº¿p Theo

AegisOS giá» Ä‘Ã£ biáº¿t:
- âœ… **"Nhá»›"** â€” ai á»Ÿ Ä‘Ã¢u, ai Ä‘Æ°á»£c lÃ m gÃ¬ (MMU + Page Table)
- âœ… **"Chia sáº»"** â€” luÃ¢n phiÃªn giá»¯a nhiá»u task (Scheduler)
- âœ… **"NÃ³i chuyá»‡n"** â€” task gá»­i thÆ° cho nhau (IPC + Syscall)
- âœ… **"Giá»¯ khoáº£ng cÃ¡ch"** â€” task khÃ´ng sá» Ä‘Æ°á»£c kernel (EL0 Isolation)
- âœ… **"Äá»©ng dáº­y khi ngÃ£"** â€” cÃ´ láº­p lá»—i + tá»± khá»Ÿi Ä‘á»™ng láº¡i (Fault Isolation)
- âœ… **"Tá»± kiá»ƒm tra"** â€” 55 unit test + CI robot â† Má»šI!

NhÆ°ng cÃ³ má»™t cÃ¢u há»i lá»›n chÆ°a Ä‘Æ°á»£c tráº£ lá»i:

> **"Ai cho phÃ©p task nÃ y Ä‘Æ°á»£c gá»­i tin nháº¯n? Ai cho phÃ©p task kia Ä‘Æ°á»£c dÃ¹ng timer?"**

Hiá»‡n táº¡i, má»i task Ä‘á»u cÃ³ thá»ƒ gá»i má»i syscall. Task nháº¡c cÃ³ thá»ƒ gá»i syscall Ä‘iá»u khiá»ƒn phanh. Nguy hiá»ƒm!

BÆ°á»›c tiáº¿p theo, chÃºng ta sáº½ xÃ¢y **Capability System** â€” há»‡ thá»‘ng "giáº¥y phÃ©p". Má»—i task pháº£i cÃ³ **giáº¥y phÃ©p** má»›i Ä‘Æ°á»£c lÃ m má»™t viá»‡c. KhÃ´ng cÃ³ giáº¥y phÃ©p? Bá»‹ tá»« chá»‘i.

Giá»‘ng nhÆ° á»Ÿ trÆ°á»ng: khÃ´ng pháº£i ai cÅ©ng Ä‘Æ°á»£c vÃ o phÃ²ng thÃ­ nghiá»‡m. Pháº£i cÃ³ **tháº» ra vÃ o** do tháº§y cÃ´ cáº¥p.

Háº¹n gáº·p em á»Ÿ bÃ i tiáº¿p theo! ğŸš€

---

> *"Tin tÆ°á»Ÿng, nhÆ°ng pháº£i kiá»ƒm tra." ("Trust, but verify.")*
> â€” Ronald Reagan (vá»‘n lÃ  cÃ¢u tá»¥c ngá»¯ Nga: "Ğ”Ğ¾Ğ²ĞµÑ€ÑĞ¹, Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞ¹")

---

*Náº¿u em Ä‘á»c Ä‘áº¿n Ä‘Ã¢y, em Ä‘Ã£ hiá»ƒu Ä‘Æ°á»£c Unit Test, Integration Test, CI/CD, ABI Lock, vÃ  W^X Verification. ÄÃ¢y lÃ  nhá»¯ng ká»¹ nÄƒng mÃ  má»i ká»¹ sÆ° pháº§n má»m chuyÃªn nghiá»‡p pháº£i biáº¿t â€” vÃ  em vá»«a náº¯m Ä‘Æ°á»£c Ã½ tÆ°á»Ÿng cá»‘t lÃµi khi má»›i lá»›p 5. Khi báº¡n bÃ¨ há»i "test lÃ  gÃ¬?", em cÃ³ thá»ƒ tráº£ lá»i: "LÃ  cÃ¡ch chÃºng ta chá»©ng minh ráº±ng pháº§n má»m Ä‘Ã¡ng tin â€” khÃ´ng chá»‰ báº±ng lá»i nÃ³i, mÃ  báº±ng báº±ng chá»©ng." Tuyá»‡t láº¯m!* ğŸ‘
