# ğŸ« Giáº¥y PhÃ©p Cho Pháº§n Má»m â€” Ai ÄÆ°á»£c LÃ m GÃ¬?

> *BÃ i #7 trong chuá»—i AegisOS â€” dÃ nh cho báº¡n nhá» mÆ¡ lÃ m ká»¹ sÆ°. HÃ´m nay: Capability â€” há»‡ thá»‘ng "giáº¥y phÃ©p" kiá»ƒm soÃ¡t tá»«ng hÃ nh Ä‘á»™ng cá»§a tá»«ng chÆ°Æ¡ng trÃ¬nh.*

---

## ğŸš€ Giáº¥c MÆ¡ TÆ°Æ¡ng Lai

NÄƒm 2043. Em lÃ  ká»¹ sÆ° pháº§n má»m cho má»™t hÃ£ng xe tá»± lÃ¡i.

Chiáº¿c xe cá»§a em cÃ³ hÃ ng chá»¥c chÆ°Æ¡ng trÃ¬nh cháº¡y cÃ¹ng lÃºc. Má»—i chÆ°Æ¡ng trÃ¬nh lo má»™t viá»‡c:

- **ChÆ°Æ¡ng trÃ¬nh camera** â€” nháº­n hÃ¬nh áº£nh tá»« camera, nháº­n diá»‡n biá»ƒn bÃ¡o.
- **ChÆ°Æ¡ng trÃ¬nh phanh** â€” Ä‘iá»u khiá»ƒn phanh, giá»¯ an toÃ n hÃ nh khÃ¡ch.
- **ChÆ°Æ¡ng trÃ¬nh nháº¡c** â€” phÃ¡t bÃ i hÃ¡t cho tÃ i xáº¿ nghe.

Ba chÆ°Æ¡ng trÃ¬nh nÃ y cháº¡y trÃªn **cÃ¹ng má»™t mÃ¡y tÃ­nh** bÃªn trong xe.

Má»™t hÃ´m, em phÃ¡t hiá»‡n má»™t lá»—i kinh hoÃ ng:

> ChÆ°Æ¡ng trÃ¬nh nháº¡c... cÃ³ thá»ƒ gá»­i lá»‡nh Ä‘áº¿n **há»‡ thá»‘ng phanh**.

TÆ°á»Ÿng tÆ°á»£ng Ä‘i. Em Ä‘ang nghe nháº¡c trÃªn xe. BÃ i hÃ¡t chuyá»ƒn sang báº£n tiáº¿p theo. VÃ  Ä‘Ãºng lÃºc Ä‘Ã³ â€” do má»™t lá»—i nhá» trong pháº§n má»m nháº¡c â€” nÃ³ gá»­i má»™t tin nháº¯n sai Ä‘áº¿n há»‡ thá»‘ng phanh. Xe **bá»—ng dÆ°ng dá»«ng láº¡i** giá»¯a Ä‘Æ°á»ng cao tá»‘c.

Xe phÃ­a sau khÃ´ng ká»‹p phanh.

*Táº¡i sao chÆ°Æ¡ng trÃ¬nh nháº¡c láº¡i Ä‘Æ°á»£c phÃ©p nÃ³i chuyá»‡n vá»›i há»‡ thá»‘ng phanh?* NÃ³ **khÃ´ng nÃªn** cÃ³ quyá»n Ä‘Ã³. Giá»‘ng nhÆ° má»™t há»c sinh lá»›p 5 khÃ´ng nÃªn cÃ³ chÃ¬a khÃ³a phÃ²ng hiá»‡u trÆ°á»Ÿng váº­y.

**NhÆ°ng náº¿u khÃ´ng ai kiá»ƒm soÃ¡t, thÃ¬ ai cÅ©ng cÃ³ thá»ƒ lÃ m báº¥t cá»© Ä‘iá»u gÃ¬.**

ÄÃ³ chÃ­nh lÃ  váº¥n Ä‘á» mÃ  AegisOS vá»«a gáº·p. VÃ  hÃ´m nay, chÃºng ta sáº½ giáº£i quyáº¿t nÃ³.

---

## ğŸ« Tháº» Ra VÃ o á» TrÆ°á»ng Há»c

### TrÆ°á»ng há»c cÃ³ quy táº¯c

Em thá»­ nghÄ© vá» trÆ°á»ng mÃ¬nh nhÃ©.

á» trÆ°á»ng, khÃ´ng pháº£i ai muá»‘n Ä‘i Ä‘Ã¢u cÅ©ng Ä‘Æ°á»£c:

- **PhÃ²ng thÃ­ nghiá»‡m** â€” chá»‰ ai cÃ³ giá» thá»±c hÃ nh má»›i Ä‘Æ°á»£c vÃ o. Pháº£i cÃ³ **tháº» ra vÃ o** do tháº§y cÃ´ cáº¥p.
- **PhÃ²ng y táº¿** â€” ai cÅ©ng Ä‘Æ°á»£c vÃ o khi bá»‹ á»‘m, nhÆ°ng khÃ´ng ai Ä‘Æ°á»£c tá»± Ã½ láº¥y thuá»‘c.
- **PhÃ²ng mÃ¡y tÃ­nh** â€” chá»‰ vÃ o Ä‘Ãºng tiáº¿t Tin há»c, vÃ  pháº£i cÃ³ tháº§y giÃ¡m sÃ¡t.
- **SÃ¢n trÆ°á»ng** â€” ai cÅ©ng Ä‘Æ°á»£c chÆ¡i trong giá» ra chÆ¡i.

Má»—i há»c sinh cÃ³ má»™t **táº­p quyá»n háº¡n** khÃ¡c nhau. Lá»›p trÆ°á»Ÿng cÃ³ thá»ƒ vÃ o phÃ²ng giÃ¡o viÃªn láº¥y sá»• Ä‘áº§u bÃ i, nhÆ°ng cÃ¡c báº¡n khÃ¡c thÃ¬ khÃ´ng.

BÃ¢y giá» tÆ°á»Ÿng tÆ°á»£ng: náº¿u trÆ°á»ng **khÃ´ng cÃ³ báº¥t ká»³ quy táº¯c nÃ o**. Ai muá»‘n vÃ o Ä‘Ã¢u cÅ©ng Ä‘Æ°á»£c. Ai muá»‘n láº¥y gÃ¬ cÅ©ng Ä‘Æ°á»£c.

Há»—n loáº¡n Ä‘Ãºng khÃ´ng?

**MÃ¡y tÃ­nh cÅ©ng váº­y.**

### AegisOS trÆ°á»›c Phase G: "Ai cÅ©ng Ä‘Æ°á»£c lÃ m má»i thá»©"

TrÆ°á»›c hÃ´m nay, AegisOS cÃ³ 5 loáº¡i "hÃ nh Ä‘á»™ng" mÃ  chÆ°Æ¡ng trÃ¬nh cÃ³ thá»ƒ lÃ m (gá»i lÃ  **syscall** â€” lá»i gá»i há»‡ thá»‘ng):

| Syscall | Ã nghÄ©a | VÃ­ dá»¥ Ä‘á»i tháº­t |
|---|---|---|
| **YIELD** | "TÃ´i nghá»‰, cho báº¡n khÃ¡c cháº¡y" | GiÆ¡ tay nhÆ°á»ng lÆ°á»£t phÃ¡t biá»ƒu |
| **SEND** | Gá»­i tin nháº¯n cho chÆ°Æ¡ng trÃ¬nh khÃ¡c | Gá»­i thÆ° cho báº¡n cÃ¹ng lá»›p |
| **RECV** | Nháº­n tin nháº¯n | Má»Ÿ thÆ° ra Ä‘á»c |
| **CALL** | Gá»­i thÆ° rá»“i Ä‘á»£i thÆ° tráº£ lá»i | Há»i báº¡n má»™t cÃ¢u, Ä‘á»£i tráº£ lá»i |
| **WRITE** | In chá»¯ ra mÃ n hÃ¬nh (UART) | Viáº¿t lÃªn báº£ng |

VÃ  AegisOS cÃ³ 2 **endpoint** (hÃ²m thÆ°) â€” nÆ¡i cÃ¡c chÆ°Æ¡ng trÃ¬nh gá»­i/nháº­n tin nháº¯n.

Váº¥n Ä‘á» lÃ : **táº¥t cáº£** chÆ°Æ¡ng trÃ¬nh Ä‘á»u cÃ³ thá»ƒ gá»i **táº¥t cáº£** syscall, trÃªn **táº¥t cáº£** hÃ²m thÆ°.

ChÆ°Æ¡ng trÃ¬nh nháº¡c cÃ³ thá»ƒ gá»­i tin nháº¯n trÃªn hÃ²m thÆ° cá»§a há»‡ thá»‘ng phanh. ChÆ°Æ¡ng trÃ¬nh idle (chÆ°Æ¡ng trÃ¬nh "ngá»§", chá»‰ Ä‘á»£i) cÃ³ thá»ƒ in chá»¯ ra UART. Báº¥t ká»³ ai cÅ©ng lÃ m Ä‘Æ°á»£c báº¥t ká»³ Ä‘iá»u gÃ¬.

> Giá»‘ng nhÆ° má»™t trÆ°á»ng há»c mÃ  **má»i há»c sinh Ä‘á»u cÃ³ chÃ¬a khÃ³a cá»§a má»i phÃ²ng**. ğŸ”‘ğŸ”‘ğŸ”‘

Nguy hiá»ƒm!

---

## ğŸ« Giáº£i PhÃ¡p: Há»‡ Thá»‘ng Giáº¥y PhÃ©p (Capability)

### Ã tÆ°á»Ÿng

Giáº£i phÃ¡p ráº¥t Ä‘Æ¡n giáº£n â€” giá»‘ng há»‡t cÃ¡ch trÆ°á»ng há»c hoáº¡t Ä‘á»™ng:

> **Má»—i chÆ°Æ¡ng trÃ¬nh Ä‘Æ°á»£c cáº¥p má»™t "tháº»"**. TrÃªn tháº» ghi rÃµ chÆ°Æ¡ng trÃ¬nh Ä‘Ã³ Ä‘Æ°á»£c phÃ©p lÃ m nhá»¯ng gÃ¬. TrÆ°á»›c khi lÃ m báº¥t ká»³ Ä‘iá»u gÃ¬, kernel kiá»ƒm tra tháº». KhÃ´ng cÃ³ quyá»n? **Tá»« chá»‘i.**

Trong khoa há»c mÃ¡y tÃ­nh, "tháº»" nÃ y gá»i lÃ  **Capability** (Ä‘á»c lÃ  "kÃª-pÆ¡-bi-li-ti", nghÄ©a lÃ  "kháº£ nÄƒng" hay "quyá»n háº¡n").

### Tháº» trÃ´ng nhÆ° tháº¿ nÃ o?

Tháº» cá»§a má»—i chÆ°Æ¡ng trÃ¬nh lÃ  **má»™t dÃ£y 64 Ã´**, má»—i Ã´ Ä‘Ã¡nh dáº¥u âœ… hoáº·c âŒ.

Má»—i Ã´ Ä‘áº¡i diá»‡n má»™t quyá»n cá»¥ thá»ƒ:

| Ã” sá»‘ | Quyá»n | Ã nghÄ©a |
|---|---|---|
| 0 | `IPC_SEND_EP0` | ÄÆ°á»£c gá»­i thÆ° trÃªn hÃ²m thÆ° #0 |
| 1 | `IPC_RECV_EP0` | ÄÆ°á»£c nháº­n thÆ° tá»« hÃ²m thÆ° #0 |
| 2 | `IPC_SEND_EP1` | ÄÆ°á»£c gá»­i thÆ° trÃªn hÃ²m thÆ° #1 |
| 3 | `IPC_RECV_EP1` | ÄÆ°á»£c nháº­n thÆ° tá»« hÃ²m thÆ° #1 |
| 4 | `WRITE` | ÄÆ°á»£c in chá»¯ ra mÃ n hÃ¬nh |
| 5 | `YIELD` | ÄÆ°á»£c nhÆ°á»ng lÆ°á»£t |
| 6â€“63 | *Dá»± trá»¯* | Äá»ƒ dÃ nh cho tÆ°Æ¡ng lai |

VÃ­ dá»¥, tháº» cá»§a **task_a** (chÆ°Æ¡ng trÃ¬nh PING) trÃ´ng nhÆ° tháº¿ nÃ y:

```
Ã”:    0  1  2  3  4  5
      âœ… âœ… âŒ âŒ âœ… âœ…
```

NghÄ©a lÃ : task_a Ä‘Æ°á»£c gá»­i/nháº­n trÃªn hÃ²m thÆ° #0, Ä‘Æ°á»£c in chá»¯, Ä‘Æ°á»£c nhÆ°á»ng lÆ°á»£t. NhÆ°ng **khÃ´ng Ä‘Æ°á»£c** dÃ¹ng hÃ²m thÆ° #1.

CÃ²n tháº» cá»§a **idle** (chÆ°Æ¡ng trÃ¬nh ngá»§):

```
Ã”:    0  1  2  3  4  5
      âŒ âŒ âŒ âŒ âŒ âœ…
```

Idle **chá»‰** Ä‘Æ°á»£c nhÆ°á»ng lÆ°á»£t. KhÃ´ng Ä‘Æ°á»£c gá»­i thÆ°. KhÃ´ng Ä‘Æ°á»£c in chá»¯. KhÃ´ng Ä‘Æ°á»£c lÃ m gÃ¬ khÃ¡c. ÄÃºng rá»“i â€” nÃ³ chá»‰ cáº§n ngá»§ thÃ´i mÃ !

### Táº¡i sao dÃ¹ng dÃ£y Ã´ 0/1?

Trong mÃ¡y tÃ­nh, má»—i Ã´ 0/1 gá»i lÃ  má»™t **bit**. Má»™t dÃ£y 64 bit = má»™t sá»‘ `u64` (sá»‘ nguyÃªn khÃ´ng dáº¥u 64 bit).

Váº­y tháº» capability chá»‰ lÃ  **má»™t con sá»‘**! Chá»‰ tá»‘n **8 byte** cho má»—i chÆ°Æ¡ng trÃ¬nh. Ba chÆ°Æ¡ng trÃ¬nh = 24 byte. Ãt hÆ¡n má»™t dÃ²ng chá»¯ em Ä‘ang Ä‘á»c.

VÃ  viá»‡c kiá»ƒm tra quyá»n? Chá»‰ cáº§n **má»™t phÃ©p tÃ­nh** mÃ  CPU lÃ m trong chÆ°a Ä‘áº§y 1 nano-giÃ¢y (má»™t pháº§n tá»· giÃ¢y):

```
(tháº»_cá»§a_task & quyá»n_cáº§n_cÃ³) == quyá»n_cáº§n_cÃ³
```

Náº¿u káº¿t quáº£ Ä‘Ãºng â†’ Ä‘Æ°á»£c phÃ©p. Náº¿u sai â†’ tá»« chá»‘i.

PhÃ©p tÃ­nh `&` á»Ÿ Ä‘Ã¢y gá»i lÃ  **AND** (phÃ©p VÃ€) â€” giá»‘ng nhÆ° kiá»ƒm tra: "Ã” nÃ y cÃ³ Ä‘Ã¡nh dáº¥u âœ… **VÃ€** Ã´ kia cÅ©ng âœ… khÃ´ng?"

Pháº§n nÃ y hÆ¡i khÃ³, nhÆ°ng em cá»© nhá»› Ã½ chÃ­nh: **kiá»ƒm tra giáº¥y phÃ©p cá»±c ká»³ nhanh** â€” nhanh Ä‘áº¿n má»©c khÃ´ng áº£nh hÆ°á»Ÿng gÃ¬ Ä‘áº¿n tá»‘c Ä‘á»™ há»‡ thá»‘ng.

---

## ğŸ” Äi SÃ¢u HÆ¡n â€” Táº¡i Sao Äiá»u NÃ y Cá»©u Máº¡ng NgÆ°á»i?

### NguyÃªn táº¯c "Least Privilege" â€” Ãt quyá»n nháº¥t cÃ³ thá»ƒ

Trong an toÃ n pháº§n má»m, cÃ³ má»™t nguyÃªn táº¯c vÃ ng:

> **Least Privilege â€” Má»—i chÆ°Æ¡ng trÃ¬nh chá»‰ Ä‘Æ°á»£c cáº¥p Ä‘Ãºng nhá»¯ng quyá»n mÃ  nÃ³ cáº§n. KhÃ´ng hÆ¡n.**

Táº¡i sao? VÃ¬ náº¿u chÆ°Æ¡ng trÃ¬nh bá»‹ lá»—i (vÃ  chÆ°Æ¡ng trÃ¬nh **luÃ´n** cÃ³ thá»ƒ bá»‹ lá»—i), thÃ¬:

- Lá»—i Ã­t quyá»n â†’ thiá»‡t háº¡i nhá» ğŸŸ¢
- Lá»—i nhiá»u quyá»n â†’ thiá»‡t háº¡i lá»›n ğŸ”´

Quay láº¡i vÃ­ dá»¥ xe tá»± lÃ¡i:

| TÃ¬nh huá»‘ng | ChÆ°Æ¡ng trÃ¬nh nháº¡c bá»‹ lá»—i | Háº­u quáº£ |
|---|---|---|
| **KhÃ´ng cÃ³ capability** | Nháº¡c gá»­i lá»‡nh sai â†’ phanh dá»«ng xe | ğŸ’€ Tai náº¡n |
| **CÃ³ capability** | Nháº¡c cá»‘ gá»­i lá»‡nh â†’ kernel kiá»ƒm tra tháº» â†’ DENIED â†’ nháº¡c bá»‹ "Ä‘uá»•i" ra â†’ phanh váº«n hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng | âœ… An toÃ n |

ÄÃ³ lÃ  sá»©c máº¡nh cá»§a capability: **má»™t lá»—i nhá» khÃ´ng thá»ƒ lan ra thÃ nh tháº£m há»a lá»›n**.

### Tháº¿ giá»›i tháº­t dÃ¹ng capability

- **seL4** â€” há»‡ Ä‘iá»u hÃ nh microkernel ná»•i tiáº¿ng nháº¥t tháº¿ giá»›i (Ä‘Æ°á»£c dÃ¹ng trong trá»±c thÄƒng quÃ¢n sá»±, drone, xe tá»± lÃ¡i) â€” dÃ¹ng há»‡ thá»‘ng capability cá»±c ká»³ phá»©c táº¡p gá»i lÃ  **CSpace** (Capability Space). Má»—i quyá»n lÃ  má»™t "vÃ©" riÃªng biá»‡t, cÃ³ thá»ƒ truyá»n tá»« chÆ°Æ¡ng trÃ¬nh nÃ y sang chÆ°Æ¡ng trÃ¬nh khÃ¡c.

- **AegisOS** cá»§a chÃºng ta dÃ¹ng cÃ¡ch Ä‘Æ¡n giáº£n hÆ¡n: **bitmask** (dÃ£y bit). Táº¡i sao? VÃ¬ AegisOS chá»‰ cÃ³ 3 chÆ°Æ¡ng trÃ¬nh tÄ©nh, khÃ´ng cáº§n phá»©c táº¡p nhÆ° seL4. NhÆ°ng **nguyÃªn táº¯c giá»‘ng há»‡t nhau**: kiá»ƒm tra quyá»n trÆ°á»›c khi cho phÃ©p hÃ nh Ä‘á»™ng.

- **Android** cÅ©ng dÃ¹ng capability! Má»—i á»©ng dá»¥ng pháº£i **xin quyá»n**: quyá»n dÃ¹ng camera, quyá»n Ä‘á»c danh báº¡, quyá»n truy cáº­p vá»‹ trÃ­... Em Ä‘Ã£ bao giá» tháº¥y cá»­a sá»• "Cho phÃ©p á»©ng dá»¥ng truy cáº­p camera?" chÆ°a? ÄÃ³ chÃ­nh lÃ  capability system!

---

## âš™ï¸ Ká»¹ Thuáº­t â€” NhÆ°ng Dá»… Hiá»ƒu

### Ba bÆ°á»›c báº£o vá»‡

Khi má»™t chÆ°Æ¡ng trÃ¬nh muá»‘n lÃ m gÃ¬ Ä‘Ã³ (vÃ­ dá»¥: gá»­i tin nháº¯n), Ä‘Ã¢y lÃ  nhá»¯ng gÃ¬ xáº£y ra bÃªn trong AegisOS:

**BÆ°á»›c 1: ChÆ°Æ¡ng trÃ¬nh gá»i syscall**

ChÆ°Æ¡ng trÃ¬nh task_a muá»‘n gá»­i tin nháº¯n trÃªn hÃ²m thÆ° #0. NÃ³ gá»i: "Há»‡ thá»‘ng Æ¡i, cho tÃ´i SEND trÃªn endpoint 0!"

**BÆ°á»›c 2: Kernel kiá»ƒm tra giáº¥y phÃ©p**

Kernel tra "tháº»" cá»§a task_a. HÃ m `cap_for_syscall` nÃ³i: "SEND trÃªn endpoint 0 cáº§n quyá»n `IPC_SEND_EP0` (Ã´ sá»‘ 0)." Kernel nhÃ¬n tháº» â€” Ã´ sá»‘ 0 cÃ³ âœ… khÃ´ng? **CÃ³!** â†’ Cho phÃ©p.

**BÆ°á»›c 3: Thá»±c thi hoáº·c tá»« chá»‘i**

- Náº¿u **cÃ³ quyá»n** â†’ kernel cháº¡y syscall bÃ¬nh thÆ°á»ng.
- Náº¿u **khÃ´ng cÃ³ quyá»n** â†’ kernel in ra: `"!!! CAP DENIED"` â†’ Ä‘Ã¡nh dáº¥u chÆ°Æ¡ng trÃ¬nh Ä‘Ã³ lÃ  **bá»‹ lá»—i** (Faulted) â†’ tá»± Ä‘á»™ng khá»Ÿi Ä‘á»™ng láº¡i sau 1 giÃ¢y.

### Äoáº¡n há»™i thoáº¡i minh há»a

HÃ£y tÆ°á»Ÿng tÆ°á»£ng kernel lÃ  **báº£o vá»‡ trÆ°á»ng há»c**, vÃ  cÃ¡c chÆ°Æ¡ng trÃ¬nh lÃ  **há»c sinh**:

> **Task_a (PING):** BÃ¡c báº£o vá»‡ Æ¡i, cho em vÃ o phÃ²ng thÆ° #0 gá»­i thÆ° áº¡!
>
> **Kernel (Báº£o vá»‡):** *(nhÃ¬n tháº»)* Em cÃ³ quyá»n "Gá»­i thÆ° phÃ²ng #0"... âœ… ÄÆ°á»£c, vÃ o Ä‘i.
>
> **Task_a:** Cáº£m Æ¡n bÃ¡c!

---

> **Idle (Ngá»§):** BÃ¡c báº£o vá»‡ Æ¡i, cho em vÃ o phÃ²ng thÆ° #0 gá»­i thÆ° áº¡!
>
> **Kernel (Báº£o vá»‡):** *(nhÃ¬n tháº»)* Em Æ¡i, tháº» em chá»‰ cÃ³ quyá»n "NhÆ°á»ng lÆ°á»£t" thÃ´i. PhÃ²ng thÆ° #0 em khÃ´ng Ä‘Æ°á»£c vÃ o.
>
> **Idle:** NhÆ°ng em muá»‘n...
>
> **Kernel:** âŒ DENIED. Em ra ngoÃ i ngá»“i Ä‘á»£i. VÃ  bÃ¡c sáº½ bÃ¡o cho tháº§y hiá»‡u trÆ°á»Ÿng.
>
> *(Idle bá»‹ Ä‘Ã¡nh dáº¥u "Faulted" â€” 1 giÃ¢y sau sáº½ Ä‘Æ°á»£c khá»Ÿi Ä‘á»™ng láº¡i, nhÆ°ng váº«n chá»‰ cÃ³ quyá»n cÅ©)*

### Táº¡i sao tá»« chá»‘i = lá»—i nghiÃªm trá»ng?

Em cÃ³ thá»ƒ há»i: "Sao khÃ´ng tráº£ lá»—i cho chÆ°Æ¡ng trÃ¬nh tá»± xá»­ lÃ½?"

LÃ½ do: trong há»‡ thá»‘ng an toÃ n cao (safety-critical), náº¿u má»™t chÆ°Æ¡ng trÃ¬nh gá»i syscall mÃ  nÃ³ **khÃ´ng cÃ³ quyá»n**, Ä‘iá»u Ä‘Ã³ cÃ³ nghÄ©a lÃ  **chÆ°Æ¡ng trÃ¬nh bá»‹ lá»—i thiáº¿t káº¿**. ÄÃ¢y khÃ´ng pháº£i tÃ¬nh huá»‘ng bÃ¬nh thÆ°á»ng â€” Ä‘Ã¢y lÃ  **lá»—i pháº§n má»m** (software defect).

Giá»‘ng nhÆ° náº¿u má»™t há»c sinh cá»‘ phÃ¡ khÃ³a phÃ²ng hiá»‡u trÆ°á»Ÿng â€” Ä‘Ã³ khÃ´ng pháº£i "xin phÃ©p bá»‹ tá»« chá»‘i". ÄÃ³ lÃ  **vi pháº¡m nghiÃªm trá»ng** cáº§n xá»­ lÃ½ ngay.

VÃ¬ váº­y, AegisOS **fault** (Ä‘Ã¡nh dáº¥u lá»—i) chÆ°Æ¡ng trÃ¬nh vi pháº¡m, rá»“i tá»± Ä‘á»™ng khá»Ÿi Ä‘á»™ng láº¡i nÃ³. An toÃ n hÆ¡n lÃ  Ä‘á»ƒ nÃ³ tiáº¿p tá»¥c cháº¡y vá»›i tráº¡ng thÃ¡i khÃ´ng xÃ¡c Ä‘á»‹nh.

---

## ğŸ› ï¸ ChÃºng Ta ÄÃ£ LÃ m ÄÆ°á»£c GÃ¬ Trong AegisOS?

### Cáº¥u trÃºc code má»›i

Phase G thÃªm má»™t module hoÃ n toÃ n má»›i vÃ o AegisOS:

```
src/
â”œâ”€â”€ boot.s          â† Khá»Ÿi Ä‘á»™ng (Phase A)
â”œâ”€â”€ mmu.rs          â† Bá»™ nhá»› (Phase B)
â”œâ”€â”€ exception.rs    â† Xá»­ lÃ½ ngoáº¡i lá»‡ (Phase C)
â”œâ”€â”€ sched.rs        â† Thá»i khÃ³a biá»ƒu (Phase C)
â”œâ”€â”€ ipc.rs          â† Gá»­i/nháº­n thÆ° (Phase C)
â”œâ”€â”€ timer.rs        â† Äá»“ng há»“ bÃ¡o thá»©c (Phase C)
â”œâ”€â”€ gic.rs          â† Bá»™ Ä‘iá»u phá»‘i ngáº¯t (Phase C)
â”œâ”€â”€ uart.rs         â† "Hai cÃ¡i lon ná»‘i dÃ¢y" (Phase A)
â”œâ”€â”€ cap.rs          â† ğŸ†• Giáº¥y phÃ©p! (Phase G)
â”œâ”€â”€ main.rs         â† HÃ m chÃ­nh + task entries
â””â”€â”€ lib.rs          â† Khai bÃ¡o module
```

### File má»›i: cap.rs â€” "Quyá»ƒn sá»• giáº¥y phÃ©p"

File [src/cap.rs](src/cap.rs) chá»‰ khoáº£ng 100 dÃ²ng, nhÆ°ng chá»©a toÃ n bá»™ há»‡ thá»‘ng capability:

- **6 háº±ng sá»‘ quyá»n** â€” má»—i quyá»n lÃ  má»™t bit riÃªng biá»‡t (bit 0, bit 1, ..., bit 5)
- **`cap_check()`** â€” hÃ m kiá»ƒm tra: "Task nÃ y cÃ³ Ä‘á»§ quyá»n khÃ´ng?" Chá»‰ má»™t phÃ©p AND, cá»±c nhanh.
- **`cap_for_syscall()`** â€” hÃ m tra báº£ng: "Syscall nÃ y cáº§n quyá»n gÃ¬?" VÃ­ dá»¥: SEND trÃªn endpoint 0 â†’ cáº§n bit 0. CALL trÃªn endpoint 0 â†’ cáº§n **cáº£** bit 0 vÃ  bit 1 (vÃ¬ CALL = gá»­i + nháº­n).
- **`cap_name()`** â€” hÃ m Ä‘áº·t tÃªn: khi tá»« chá»‘i, in ra "IPC_SEND_EP0" thay vÃ¬ "bit 0" cho dá»… Ä‘á»c.

### Thay Ä‘á»•i trong sched.rs â€” "DÃ¡n tháº» lÃªn má»—i task"

Má»—i chÆ°Æ¡ng trÃ¬nh (task) cÃ³ má»™t **TCB** (Task Control Block â€” "há»“ sÆ¡ chÆ°Æ¡ng trÃ¬nh"). ChÃºng ta thÃªm má»™t trÆ°á»ng má»›i vÃ o há»“ sÆ¡:

```
TCB (trÆ°á»›c Phase G):          TCB (sau Phase G):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ context      â”‚              â”‚ context      â”‚
â”‚ state        â”‚              â”‚ state        â”‚
â”‚ id           â”‚              â”‚ id           â”‚
â”‚ stack_top    â”‚              â”‚ stack_top    â”‚
â”‚ entry_point  â”‚              â”‚ entry_point  â”‚
â”‚ user_stack   â”‚              â”‚ user_stack   â”‚
â”‚ fault_tick   â”‚              â”‚ fault_tick   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ caps  ğŸ†•     â”‚  â† 8 byte, dÃ£y 64 bit
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

TrÆ°á»ng `caps` náº±m cuá»‘i struct, nÃªn **khÃ´ng lÃ m xÃ¡o trá»™n** vá»‹ trÃ­ cÃ¡c trÆ°á»ng cÅ©. Táº¥t cáº£ code cÅ© váº«n hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng.

### Thay Ä‘á»•i trong exception.rs â€” "Báº£o vá»‡ kiá»ƒm tra tháº»"

Trong hÃ m `handle_svc` (nÆ¡i kernel xá»­ lÃ½ má»i syscall), chÃºng ta thÃªm má»™t bÆ°á»›c kiá»ƒm tra **ngay trÆ°á»›c** khi thá»±c thi:

```
TRÆ¯á»šC Phase G:                      SAU Phase G:

Task gá»i syscall                    Task gá»i syscall
       â†“                                  â†“
                                    Tra tháº» capability
                                          â†“
                                    CÃ³ quyá»n? â”€â”€â”€ KhÃ´ng â”€â”€â†’ FAULT!
                                       â”‚
                                      CÃ³
                                       â†“
Thá»±c thi syscall                    Thá»±c thi syscall
```

Chá»‰ thÃªm 10 dÃ²ng code. NhÆ°ng 10 dÃ²ng Ä‘Ã³ **báº£o vá»‡ toÃ n bá»™ há»‡ thá»‘ng**.

### Thay Ä‘á»•i trong main.rs â€” "PhÃ¡t tháº» cho má»—i task"

Trong hÃ m `kernel_main()`, sau khi khá»Ÿi táº¡o scheduler, kernel **phÃ¡t tháº»** cho tá»«ng task:

| Task | Vai trÃ² | Quyá»n Ä‘Æ°á»£c cáº¥p |
|---|---|---|
| task_a | PING (gá»­i/nháº­n thÆ°) | Gá»­i EP0 âœ… â€¢ Nháº­n EP0 âœ… â€¢ Viáº¿t âœ… â€¢ NhÆ°á»ng âœ… |
| task_b | PONG (nháº­n/gá»­i thÆ°) | Gá»­i EP0 âœ… â€¢ Nháº­n EP0 âœ… â€¢ Viáº¿t âœ… â€¢ NhÆ°á»ng âœ… |
| idle | Ngá»§ | NhÆ°á»ng âœ… *(chá»‰ váº­y thÃ´i!)* |

Khi QEMU khá»Ÿi Ä‘á»™ng, em sáº½ tháº¥y dÃ²ng má»›i:

```
[AegisOS] capabilities assigned
```

NghÄ©a lÃ : má»i tháº» Ä‘Ã£ Ä‘Æ°á»£c phÃ¡t. Há»‡ thá»‘ng sáºµn sÃ ng.

### Äiá»u ká»³ diá»‡u: tháº» tá»“n táº¡i sau khi restart

Nhá»› bÃ i #5 khÃ´ng? Khi má»™t task bá»‹ lá»—i, AegisOS tá»± Ä‘á»™ng restart nÃ³ sau 1 giÃ¢y.

CÃ¢u há»i: khi restart, tháº» capability cÃ³ bá»‹ máº¥t khÃ´ng?

**KhÃ´ng!** HÃ m `restart_task()` chá»‰ xÃ³a **context** (tráº¡ng thÃ¡i CPU) vÃ  Ä‘áº·t láº¡i **entry point** (Ä‘iá»ƒm báº¯t Ä‘áº§u). TrÆ°á»ng `caps` náº±m ngoÃ i pháº¡m vi xÃ³a â†’ **tá»± Ä‘á»™ng Ä‘Æ°á»£c giá»¯ nguyÃªn**.

Äiá»u nÃ y ráº¥t quan trá»ng: capability lÃ  **chÃ­nh sÃ¡ch tÄ©nh** â€” Ä‘Æ°á»£c gÃ¡n má»™t láº§n bá»Ÿi kernel, tá»“n táº¡i suá»‘t Ä‘á»i task. Task bá»‹ lá»—i restart láº¡i váº«n chá»‰ cÃ³ Ä‘Ãºng nhá»¯ng quyá»n cÅ©. KhÃ´ng hÆ¡n, khÃ´ng kÃ©m.

---

## ğŸ§ª Kiá»ƒm Tra â€” 69 BÃ i Test Äá»u Äáº¡t!

Nhá»› bÃ i #6 khÃ´ng? ChÃºng ta cÃ³ 55 bÃ i test. Phase G thÃªm **14 bÃ i test má»›i**:

| NhÃ³m test | Kiá»ƒm tra gÃ¬ | Sá»‘ test |
|---|---|---|
| Bit constants | 6 quyá»n pháº£i khÃ¡c nhau, má»—i quyá»n Ä‘Ãºng 1 bit | 1 |
| cap_check logic | Kiá»ƒm tra phÃ©p AND hoáº¡t Ä‘á»™ng Ä‘Ãºng | 3 |
| cap_for_syscall | Má»—i syscall + endpoint â†’ Ä‘Ãºng quyá»n cáº§n thiáº¿t | 5 |
| cap_name | TÃªn quyá»n in ra Ä‘Ãºng tiáº¿ng Anh | 1 |
| TCB integration | Tháº» má»›i = 0 trong EMPTY_TCB | 1 |
| Restart survival | Tháº» váº«n cÃ²n sau khi task restart | 1 |
| CAP_ALL / CAP_NONE | Bao gá»“m táº¥t cáº£ / khÃ´ng cÃ³ gÃ¬ | 2 |

Tá»•ng: **69 test, táº¥t cáº£ Ä‘áº¡t** âœ…

VÃ  trÃªn QEMU tháº­t: **9 checkpoint boot Ä‘á»u pass** â€” bao gá»“m checkpoint má»›i `[AegisOS] capabilities assigned`.

---

## ğŸ’¡ Truyá»n Cáº£m Há»©ng â€” NgÆ°á»i PhÃ¡t Minh Ra Capability

CÃ¢u chuyá»‡n vá» capability báº¯t Ä‘áº§u tá»« nÄƒm **1966** â€” khi má»™t nhÃ  khoa há»c mÃ¡y tÃ­nh tÃªn **Jack Dennis** á»Ÿ MIT (Viá»‡n CÃ´ng nghá»‡ Massachusetts) Ä‘áº·t cÃ¢u há»i:

> "LÃ m sao cho má»—i chÆ°Æ¡ng trÃ¬nh chá»‰ truy cáº­p Ä‘Æ°á»£c Ä‘Ãºng nhá»¯ng gÃ¬ nÃ³ cáº§n?"

Ã”ng phÃ¡t minh ra khÃ¡i niá»‡m **capability** â€” má»™t "vÃ©" mÃ  chÆ°Æ¡ng trÃ¬nh pháº£i xuáº¥t trÃ¬nh trÆ°á»›c khi truy cáº­p báº¥t ká»³ tÃ i nguyÃªn nÃ o.

Gáº§n 60 nÄƒm sau, Ã½ tÆ°á»Ÿng cá»§a Ã´ng váº«n lÃ  ná»n táº£ng cá»§a má»i há»‡ thá»‘ng an toÃ n:

- **seL4** (2009) â€” microkernel Ä‘Æ°á»£c **chá»©ng minh toÃ¡n há»c** lÃ  Ä‘Ãºng, dÃ¹ng capability.
- **Google Fuchsia** (2016) â€” há»‡ Ä‘iá»u hÃ nh má»›i cá»§a Google, dÃ¹ng capability.
- **CHERI** (2014) â€” chip CPU do Cambridge phÃ¡t triá»ƒn, nhÃºng capability **vÃ o pháº§n cá»©ng**.
- **AegisOS** (2026) â€” microkernel nhá» bÃ© cá»§a chÃºng ta, cÅ©ng dÃ¹ng capability! ğŸ‰

Jack Dennis báº¯t Ä‘áº§u nghiÃªn cá»©u khi Ã´ng lÃ  **sinh viÃªn** á»Ÿ MIT. Ã”ng tÃ² mÃ², Ã´ng Ä‘áº·t cÃ¢u há»i, Ã´ng thá»­ nghiá»‡m. VÃ  Ã½ tÆ°á»Ÿng cá»§a Ã´ng thay Ä‘á»•i cáº£ ngÃ nh khoa há»c mÃ¡y tÃ­nh.

Em cÅ©ng cÃ³ thá»ƒ báº¯t Ä‘áº§u nhÆ° váº­y. TÃ² mÃ². Äáº·t cÃ¢u há»i. Thá»­ nghiá»‡m.

---

## ğŸ”® BÆ°á»›c Tiáº¿p Theo

AegisOS giá» Ä‘Ã£ biáº¿t:

- âœ… **"Nhá»›"** â€” ai á»Ÿ Ä‘Ã¢u, ai Ä‘Æ°á»£c lÃ m gÃ¬ (MMU + Page Table)
- âœ… **"Chia sáº»"** â€” luÃ¢n phiÃªn giá»¯a nhiá»u task (Scheduler)
- âœ… **"NÃ³i chuyá»‡n"** â€” task gá»­i thÆ° cho nhau (IPC + Syscall)
- âœ… **"Giá»¯ khoáº£ng cÃ¡ch"** â€” task khÃ´ng sá» Ä‘Æ°á»£c kernel (EL0 Isolation)
- âœ… **"Äá»©ng dáº­y khi ngÃ£"** â€” cÃ´ láº­p lá»—i + tá»± khá»Ÿi Ä‘á»™ng láº¡i (Fault Isolation)
- âœ… **"Tá»± kiá»ƒm tra"** â€” 69 unit test + 9 boot checkpoint (Testing)
- âœ… **"Kiá»ƒm soÃ¡t quyá»n"** â€” má»—i task chá»‰ lÃ m Ä‘Æ°á»£c Ä‘iá»u nÃ³ Ä‘Æ°á»£c phÃ©p â† Má»šI!

NhÆ°ng váº«n cÃ²n má»™t cÃ¢u há»i:

> **"Náº¿u task_a bá»‹ hacker chiáº¿m quyá»n Ä‘iá»u khiá»ƒn â€” nÃ³ cÃ³ thá»ƒ Ä‘á»c bá»™ nhá»› cá»§a task_b khÃ´ng?"**

Hiá»‡n táº¡i, táº¥t cáº£ task chia chung má»™t **báº£n Ä‘á»“ bá»™ nhá»›** (identity map). Task_a vÃ  task_b nhÃ¬n tháº¥y cÃ¹ng má»™t khÃ´ng gian Ä‘á»‹a chá»‰. Capability kiá»ƒm soÃ¡t **syscall**, nhÆ°ng khÃ´ng kiá»ƒm soÃ¡t **bá»™ nhá»›**.

BÆ°á»›c tiáº¿p theo, chÃºng ta sáº½ xÃ¢y **Per-Task Address Space** â€” má»—i task cÃ³ báº£n Ä‘á»“ bá»™ nhá»› riÃªng. Task_a khÃ´ng thá»ƒ nhÃ¬n tháº¥y dá»¯ liá»‡u cá»§a task_b, dÃ¹ cÃ³ cá»‘ truy cáº­p cÃ¹ng Ä‘á»‹a chá»‰.

Giá»‘ng nhÆ° má»—i lá»›p há»c cÃ³ **phÃ²ng riÃªng**. Lá»›p 5A khÃ´ng nhÃ¬n tháº¥y báº£ng cá»§a lá»›p 5B, dÃ¹ hai phÃ²ng á»Ÿ cáº¡nh nhau.

Háº¹n gáº·p em á»Ÿ bÃ i tiáº¿p theo! ğŸš€

---

> *"NguyÃªn táº¯c Ã­t quyá»n nháº¥t (Least Privilege): má»—i chÆ°Æ¡ng trÃ¬nh chá»‰ nÃªn cÃ³ Ä‘Ãºng nhá»¯ng quyá»n cáº§n thiáº¿t Ä‘á»ƒ hoÃ n thÃ nh nhiá»‡m vá»¥ â€” khÃ´ng hÆ¡n."*
> â€” Jerome Saltzer & Michael Schroeder, 1975

---

*Náº¿u em Ä‘á»c Ä‘áº¿n Ä‘Ã¢y, em Ä‘Ã£ hiá»ƒu Ä‘Æ°á»£c Capability, Least Privilege, Bitmask, vÃ  cÃ¡ch AegisOS kiá»ƒm soÃ¡t quyá»n truy cáº­p â€” nhá»¯ng khÃ¡i niá»‡m mÃ  ká»¹ sÆ° báº£o máº­t chuyÃªn nghiá»‡p dÃ¹ng hÃ ng ngÃ y. Láº§n sau ai há»i em "Táº¡i sao Ä‘iá»‡n thoáº¡i hay há»i 'Cho phÃ©p á»©ng dá»¥ng truy cáº­p camera?'", em cÃ³ thá»ƒ tráº£ lá»i: "VÃ¬ má»—i á»©ng dá»¥ng cáº§n cÃ³ giáº¥y phÃ©p. ÄÃ³ gá»i lÃ  capability." Ngáº§u láº¯m!* ğŸ‘
