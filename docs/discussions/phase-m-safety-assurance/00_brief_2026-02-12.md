# ğŸ“‹ Äá» BÃ i Tháº£o Luáº­n â€” Phase M: Safety Assurance Foundation

> **NgÃ y táº¡o:** 2026-02-12
> **Táº¡o bá»Ÿi:** ğŸ¼ Orchestra Agent
> **Participants:** GPT-Visionary-Agent (Visionary), Gemini-Pragmatist-Agent (Pragmatist)

---

## 1. Bá»‘i cáº£nh dá»± Ã¡n

**AegisOS** lÃ  bare-metal AArch64 microkernel nháº¯m Ä‘áº¿n há»‡ thá»‘ng safety-critical (tÃªn lá»­a, y táº¿, xe tá»± lÃ¡i). Sau 12 phases (Aâ†’L), kernel cÃ³:

| ThÃ nh tá»±u | Sá»‘ liá»‡u |
|---|---|
| Host unit tests | **189** (19 test groups) |
| QEMU boot checkpoints | **25** |
| Syscalls | **13** (0â€“12) |
| Capability bits | **18/64** used |
| Module structure | `arch/aarch64/` + `kernel/` + `platform/` (Phase L) |
| ELF loader | Parse + load user binary (Phase L) |
| Tasks | **3 static** (NUM_TASKS = 3, no dynamic create) |
| Constraints | **No heap, no FP/SIMD, single-core** |

### Hiá»‡n tráº¡ng code â€” Váº¥n Ä‘á» cáº§n giáº£i quyáº¿t

**8 `static mut` globals** trÃ n lan trong `kernel/`:

| Biáº¿n | File | Loáº¡i |
|---|---|---|
| `TCBS: [Tcb; 3]` | `kernel/sched.rs` | `pub static mut` |
| `CURRENT: usize` | `kernel/sched.rs` | `pub static mut` |
| `EPOCH_TICKS: u64` | `kernel/sched.rs` | `pub static mut` |
| `ENDPOINTS: [Endpoint; 4]` | `kernel/ipc.rs` | `pub static mut` |
| `GRANTS: [Grant; 2]` | `kernel/grant.rs` | `pub static mut` |
| `IRQ_BINDINGS: [IrqBinding; 4]` | `kernel/irq.rs` | `pub static mut` |
| `TICK_COUNT: u64` | `kernel/timer.rs` | `pub static mut` |
| `TICK_INTERVAL: u64` | `kernel/timer.rs` | `static mut` |

**KhÃ´ng cÃ³:**
- Code coverage measurement (0% measured â€” DO-178C Level C yÃªu cáº§u Statement Coverage)
- Formal verification (SEED1 endgame: "Formal Verification lÃ  Ä‘Ã­ch Ä‘áº¿n cuá»‘i cÃ¹ng")
- Traceability matrix (DO-178C Â§5.5: bidirectional requirementâ†”codeâ†”test)
- Structured logging (chá»‰ cÃ³ `uart_print!` ad-hoc)
- Enhanced panic handler (chá»‰ in "PANIC" rá»“i loop)

### TiÃªu chuáº©n an toÃ n liÃªn quan

Dá»± Ã¡n cÃ³ 3 tÃ i liá»‡u tiÃªu chuáº©n trong `docs/standard/`:
- **DO-178C** (hÃ ng khÃ´ng): MC/DC coverage, traceability, formal methods (DO-333)
- **IEC 62304** (y táº¿): Software safety classification, unit verification
- **ISO 26262** (Ã´ tÃ´): ASIL classification, freedom from interference, WCET analysis

### Endgame tá»« SEED1.md

> *"4. Endgame: Formal Verification âœ… (Chá»©ng minh toÃ¡n há»c lÃ  Ä‘Ã­ch Ä‘áº¿n cuá»‘i cÃ¹ng)"*

---

## 2. Äá» xuáº¥t Phase M â€” Safety Assurance Foundation

Phase M Ä‘Æ°á»£c Ä‘á» xuáº¥t vá»›i **6 sub-phases**:

| Sub-phase | TÃªn | MÃ´ táº£ tÃ³m táº¯t |
|---|---|---|
| **M1** | Unsafe Audit & Encapsulation | Wrap 8 `static mut` trong `UnsafeCell` + safe accessor, giáº£m unsafe surface |
| **M2** | Structured Kernel Logging | Macro `klog!(level, "msg")` vá»›i Level/tick/taskID, compile-time filtering |
| **M3** | Enhanced Panic Handler | In file:line, task ID, tick count, ESR/FAR. Diagnostic info cho production |
| **M4** | Code Coverage Measurement | `cargo-llvm-cov` trong CI, Ä‘o baseline statement coverage (~50-65%) |
| **M5** | Formal Verification (Kani) | Proof harnesses cho `cap.rs`, `elf.rs`, `ipc.rs` â€” chá»©ng minh no-panic, no-OOB |
| **M6** | Traceability Matrix | DO-178C Â§5.5: Requirement â†” Source â†” Test bidirectional table |

**Æ¯á»›c lÆ°á»£ng:** ~15-20 tests má»›i, ~15 Kani proofs, 3 QEMU checkpoints má»›i, 0 syscalls má»›i.

---

## 3. CÃ¢u há»i cá»¥ thá»ƒ cáº§n tháº£o luáº­n

### CÃ¢u há»i 1: Thá»© tá»± Æ°u tiÃªn cÃ¡c sub-phases

M1 (unsafe audit) vÃ  M4 (coverage) Ä‘á»u lÃ  ná»n táº£ng nhÆ°ng cÃ³ trade-off:
- M1 trÆ°á»›c â†’ API sáº¡ch hÆ¡n cho Kani (M5) â†’ nhÆ°ng tá»‘n effort refactor, risk break tests
- M4 trÆ°á»›c â†’ biáº¿t baseline coverage ngay, guide test effort â†’ nhÆ°ng coverage number sáº½ thay Ä‘á»•i sau M1

**NÃªn triá»ƒn khai theo thá»© tá»± nÃ o? CÃ³ sub-phase nÃ o nÃªn bá» hoáº·c gá»™p?**

### CÃ¢u há»i 2: `static mut` â€” Encapsulate hay cháº¥p nháº­n SAFETY comments?

Hai trÆ°á»ng phÃ¡i:
- **Encapsulate**: Wrap trong `UnsafeCell` + module-private struct â†’ safe API surface, formal tools dá»… verify hÆ¡n. **NhÆ°ng**: thay Ä‘á»•i internal API, pháº£i sá»­a ~80 unsafe blocks + 189 tests, risk regression.
- **SAFETY comments**: Giá»¯ nguyÃªn `static mut`, thÃªm `// SAFETY: single-core, interrupts disabled during access` á»Ÿ má»i `unsafe {}` block. **NhÆ°ng**: formal tools (Kani, Miri) váº«n khÃ´ng thá»ƒ reason, DO-178C auditor sáº½ flag.

**TrÆ°á»ng phÃ¡i nÃ o phÃ¹ há»£p cho AegisOS á»Ÿ giai Ä‘oáº¡n hiá»‡n táº¡i? CÃ³ middle-ground nÃ o?**

### CÃ¢u há»i 3: Kani Formal Verification â€” kháº£ thi khÃ´ng?

Kani (AWS model checker) dÃ¹ng CBMC backend:
- **Pro**: Chá»©ng minh exhaustive cho bounded inputs, Rust-native, tÃ­ch há»£p `cargo`
- **Con**: Chá»‰ verify `#[cfg(kani)]` code trÃªn x86_64 host. KhÃ´ng verify inline asm. Bounded model checking â†’ cáº§n `kani::unwind()` limits. CÃ³ thá»ƒ timeout cho IPC state machine phá»©c táº¡p.
- **Thá»±c táº¿**: Cáº§n cÃ i trÃªn Linux (khÃ´ng native Windows). Dev environment hiá»‡n táº¡i lÃ  Windows â†’ cáº§n WSL hoáº·c Docker.

**Kani cÃ³ Ä‘Ã¡ng Ä‘áº§u tÆ° cho AegisOS khÃ´ng? Hay nÃªn dÃ¹ng approach khÃ¡c (Prusti, CBMC trá»±c tiáº¿p, property-based testing vá»›i proptest)?**

### CÃ¢u há»i 4: Code coverage â€” target bao nhiÃªu %?

DO-178C Level A: MC/DC (modified condition/decision coverage)
DO-178C Level C: Statement Coverage
Hiá»‡n táº¡i: 0% measured.

Coverage chá»‰ Ä‘o Ä‘Æ°á»£c trÃªn **host tests** (x86_64) â€” `arch/` code khÃ´ng thá»ƒ measure. Kernel logic trong `kernel/` ~50-65% covered (Æ°á»›c tÃ­nh).

**NÃªn Ä‘áº·t target coverage bao nhiÃªu cho Phase M? VÃ  coverage cá»§a module nÃ o quan trá»ng nháº¥t?**

### CÃ¢u há»i 5: Tradeoff giá»¯a Safety Foundation (Phase M) vs Feature Development (Dynamic Tasks / RISC-V port)

AegisOS hiá»‡n táº¡i:
- **Äá»§ features** cho demo microkernel (scheduler, IPC, cap, ELF loader, user-mode driver)
- **Thiáº¿u evidence** ráº±ng features Ä‘Ã³ Ä‘Ãºng (no formal proof, no coverage, no traceability)
- **NUM_TASKS = 3 cá»‘ Ä‘á»‹nh** â€” ráº¥t giá»›i háº¡n cho real-world use

**NÃªn invest vÃ o Safety Foundation (Phase M) trÆ°á»›c? Hay xen káº½ features (expand NUM_TASKS, add filesystem) Ä‘á»ƒ kernel "thá»±c dá»¥ng" hÆ¡n trÆ°á»›c khi verify?**

---

## 4. RÃ ng buá»™c Ä‘Ã£ biáº¿t

| # | RÃ ng buá»™c | KhÃ´ng thá»ƒ thÆ°Æ¡ng lÆ°á»£ng? |
|---|---|---|
| 1 | **No heap** â€” táº¥t cáº£ allocation static | âœ… Báº¥t biáº¿n |
| 2 | **No FP/SIMD** â€” CPACR_EL1.FPEN = 0 | âœ… Báº¥t biáº¿n |
| 3 | **TrapFrame = 288 bytes** â€” ABI-locked | âœ… Báº¥t biáº¿n |
| 4 | **189 tests pháº£i tiáº¿p tá»¥c pass** | âœ… Backward compat |
| 5 | **25 QEMU checkpoints pháº£i pass** | âœ… Backward compat |
| 6 | **Single-core** (core 0 only) | âœ… Hiá»‡n táº¡i |
| 7 | **Dev environment = Windows** | âš ï¸ CÃ³ WSL/Docker |
| 8 | **`core::fmt` cÃ³ thá»ƒ emit FP instructions** | âš ï¸ Cáº§n verify |
| 9 | **Kani khÃ´ng há»— trá»£ inline asm** | âš ï¸ Chá»‰ verify `kernel/` |
| 10 | **Solo developer** (1 ngÆ°á»i) | âš ï¸ áº¢nh hÆ°á»Ÿng scope |

---

## 5. TiÃªu chÃ­ Ä‘Ã¡nh giÃ¡ thÃ nh cÃ´ng

| # | TiÃªu chÃ­ | Äo lÆ°á»ng |
|---|---|---|
| 1 | **Unsafe surface giáº£m** | Sá»‘ `unsafe {}` blocks giáº£m â‰¥30% hoáº·c táº­p trung vÃ o â‰¤5 wrapper modules |
| 2 | **Coverage baseline Ä‘o Ä‘Æ°á»£c** | CI produce lcov report, README cÃ³ badge |
| 3 | **Formal proofs pass** | â‰¥10 Kani proofs verified cho â‰¥2 kernel modules |
| 4 | **Traceability matrix tá»“n táº¡i** | â‰¥50 requirementâ†’codeâ†’test links documented |
| 5 | **Structured logging hoáº¡t Ä‘á»™ng** | `klog!` macro dÃ¹ng Ä‘Æ°á»£c trÃªn cáº£ host test vÃ  QEMU |
| 6 | **Backward compatible** | 189 tests + 25 checkpoints váº«n pass, 0 syscall API break |
| 7 | **Thá»i gian há»£p lÃ½** | Phase M hoÃ n thÃ nh trong â‰¤6 sub-phases, khÃ´ng phÃ¬nh scope |

---

> **ğŸ¼ Orchestra:** Äá» bÃ i Ä‘Ã£ sáºµn sÃ ng. GPT-Visionary-Agent vÃ  Gemini-Pragmatist-Agent sáº½ review vÃ  Ä‘Æ°a ra quan Ä‘iá»ƒm á»Ÿ Round 1.
