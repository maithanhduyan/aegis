# ğŸ“‹ Äá» bÃ i tháº£o luáº­n â€” Phase P: Formal Verification Expansion

> **NgÃ y:** 2026-02-13
> **Chá»§ Ä‘á»:** Má»Ÿ rá»™ng chá»©ng minh hÃ¬nh thá»©c (Kani) cho grant/irq/watchdog, tÃ­ch há»£p Miri, FM.A-7 mapping, README refresh
> **Participants:** GPT-Visionary-Agent, Gemini-Pragmatist-Agent
> **Káº¿ hoáº¡ch tham chiáº¿u:** `docs/plan/16-plan-phase-p-formal-verification-expansion_2026-02-13_10-00.md`

---

## Bá»‘i cáº£nh dá»± Ã¡n

### Tráº¡ng thÃ¡i hiá»‡n táº¡i (sau Phase O)

AegisOS Ä‘Ã£ hoÃ n thÃ nh **15 phases (Aâ†’O)** vá»›i:

- **8 tasks** (0â€“1 kernel-defined, 2â€“4 ELF-loaded, 5â€“6 reserved, 7=IDLE)
- **14 syscalls** (0â€“13), **19 capability bits** (0â€“18)
- **241 host tests**, **32 QEMU checkpoints**, **10 Kani proofs**
- **3 ELF user tasks** (hello, sensor, logger) + `libsyscall` shared library
- **`KernelCell<T>`** wrapping táº¥t cáº£ struct-array globals (0 `static mut` cho structs)
- **99.02% test coverage** trÃªn host tests

### PhÃ¢n bá»• Kani proofs hiá»‡n táº¡i (khÃ´ng Ä‘á»u)

| Module | File | Proofs | Tráº¡ng thÃ¡i |
|---|---|---|---|
| Capability | `kernel/cap.rs` | 2 | âœ… Äáº§y Ä‘á»§ |
| Scheduler | `kernel/sched.rs` | 2 | âš ï¸ CÆ¡ báº£n â€” chÆ°a cÃ³ watchdog/budget |
| IPC | `kernel/ipc.rs` | 3 | âœ… Tá»‘t â€” cÃ³ pure functions |
| MMU | `mmu.rs` | 2 | âœ… Äáº§y Ä‘á»§ |
| ELF loader | `platform/qemu_virt.rs` | 1 | âœ… Äáº§y Ä‘á»§ |
| **Grant** | **`kernel/grant.rs`** | **0** | ğŸ”´ **Lá»— há»•ng** |
| **IRQ** | **`kernel/irq.rs`** | **0** | ğŸ”´ **Lá»— há»•ng** |
| **Watchdog** | **trong `kernel/sched.rs`** | **0** | ğŸ”´ **Lá»— há»•ng** |

### Pattern Ä‘Ã£ thiáº¿t láº­p (Phase O â€” IPC pure functions)

Phase O Ä‘Ã£ extract 2 pure functions trong `ipc.rs` dÆ°á»›i `#[cfg(kani)]`:

```rust
#[cfg(kani)]
fn copy_message_pure(src: &[u64; MSG_REGS], dst: &[u64; MSG_REGS]) -> [u64; MSG_REGS] { ... }

#[cfg(kani)]
fn cleanup_pure(
    sender_tasks: &mut [[usize; MAX_WAITERS]; MAX_ENDPOINTS],
    sender_heads: &mut [usize; MAX_ENDPOINTS],
    ...
) { ... }
```

CÃ¡c hÃ m nÃ y **chá»‰ tá»“n táº¡i trong Kani build** â€” hÃ m gá»‘c (`copy_message`, `cleanup_task`) váº«n trá»±c tiáº¿p dÃ¹ng globals.

### Code thá»±c táº¿ cá»§a 3 module target

**Grant (`kernel/grant.rs` â€” 196 dÃ²ng):**
- `GRANTS: KernelCell<[Grant; 2]>` (MAX_GRANTS = 2)
- 3 functions: `grant_create`, `grant_revoke`, `cleanup_task`
- Táº¥t cáº£ trá»±c tiáº¿p dÃ¹ng `unsafe { (*GRANTS.get_mut())[i]... }`
- **Cleanup asymmetry:** Owner fault â†’ full zero (`EMPTY_GRANT`); Peer fault â†’ chá»‰ clear `peer` + deactivate
- CÃ³ `#[cfg(target_arch)]` branches cho MMU calls

**IRQ (`kernel/irq.rs` â€” 261 dÃ²ng):**
- `IRQ_BINDINGS: KernelCell<[IrqBinding; 8]>` (MAX_IRQ_BINDINGS = 8)
- 4 functions: `irq_bind`, `irq_ack`, `irq_route`, `irq_cleanup_task`
- `irq_route` cÃ³ 2 variants: aarch64 (nháº­n `&mut TrapFrame`) vÃ  host test (`irq_route_test`)
- **Cleanup:** Linear scan â†’ unmask pending_ack â†’ disable INTID â†’ set `EMPTY_BINDING`
- **Tiá»m áº©n:** KhÃ´ng detect notify_bit collision (2 INTID cÃ¹ng task cÃ¹ng bit)

**Watchdog (trong `kernel/sched.rs`):**
- TCB fields: `heartbeat_interval: u64`, `last_heartbeat: u64`
- `watchdog_scan()`: scan all tasks, check `elapsed > hb`, fault náº¿u vi pháº¡m
- `record_heartbeat()`: set interval + update last_heartbeat
- `epoch_reset()`: reset `ticks_used` cho táº¥t cáº£ non-Inactive/non-Exited tasks
- **DÃ¹ng `crate::timer::tick_count()`** â€” external dependency khÃ³ mock trong pure function

### TiÃªu chuáº©n an toÃ n liÃªn quan

| TiÃªu chuáº©n | Äiá»u khoáº£n | YÃªu cáº§u |
|---|---|---|
| DO-333 | FM.A-5 | Formal verification of source code |
| DO-333 | FM.A-7 | Verification coverage documentation |
| DO-333 | Â§6.3 | Abstract Interpretation (â†’ Miri) |
| ISO 26262 | Part 9 Â§7 | DFA â€” freedom from interference (â†’ grant proofs) |
| DO-178C | Â§4 | Bidirectional traceability (â†’ FM.A-7 mapping) |

---

## CÃ¢u há»i tháº£o luáº­n

### CÃ¢u há»i 1: Pure function extraction â€” `#[cfg(kani)]` only hay always-available?

Phase O chá»‰ dÃ¹ng `#[cfg(kani)]` cho pure functions (chÃºng chá»‰ tá»“n táº¡i khi build Kani). Phase P cÃ³ nÃªn:

**Option A â€” Kani-only (theo pattern Phase O):**
- Pure functions chá»‰ cÃ³ `#[cfg(kani)]`
- HÃ m gá»‘c váº«n giá»¯ nguyÃªn logic + globals
- Pro: Zero risk thay Ä‘á»•i runtime behavior; Ã­t diff
- Con: Host tests KHÃ”NG dÃ¹ng Ä‘Æ°á»£c pure functions; logic bá»‹ duplicate (gá»‘c + pure)

**Option B â€” Always-available (refactor tháº­t):**
- Pure functions lÃ  `pub fn`, khÃ´ng `#[cfg(kani)]`
- HÃ m gá»‘c gá»i pure function rá»“i apply vÃ o globals
- Pro: Host tests cÅ©ng dÃ¹ng pure functions; single source of truth; giáº£m duplication
- Con: Thay Ä‘á»•i call path cá»§a production code â†’ risk regression; pháº£i update 241 existing tests náº¿u signature thay Ä‘á»•i

**Option C â€” Hybrid (pure fn public, nhÆ°ng hÃ m gá»‘c giá»¯ logic inline):**
- Pure functions public, dÃ¹ng cho Kani + host tests má»›i
- HÃ m gá»‘c KHÃ”NG gá»i pure function â€” giá»¯ nguyÃªn logic hiá»‡n táº¡i
- Pro: KhÃ´ng risk regression; pure functions sáºµn sÃ ng cho host tests
- Con: Logic duplicate giá»¯a gá»‘c vÃ  pure â€” cÃ³ thá»ƒ drift theo thá»i gian

**Trade-offs cáº§n cÃ¢n nháº¯c:**
- Watchdog dÃ¹ng `crate::timer::tick_count()` â€” pure function cáº§n nháº­n `now` as parameter thay vÃ¬ gá»i global. Option B buá»™c thay signature watchdog_scan().
- Grant/IRQ cÃ³ `#[cfg(target_arch)]` blocks cho MMU/GIC calls â€” pure functions chá»‰ cover logic, khÃ´ng cover side effects.
- `KernelCell::get_mut()` Ä‘Ã£ lÃ  unsafe â€” chuyá»ƒn sang Option B khÃ´ng loáº¡i bá» unsafe, chá»‰ di chuyá»ƒn nÃ³.

---

### CÃ¢u há»i 2: Kani proof granularity â€” symbolic state Ä‘áº§y Ä‘á»§ hay constrained?

Kani dÃ¹ng **bounded model checking** â€” má»—i biáº¿n symbolic tÄƒng state space exponentially. IRQ table cÃ³ 8 bindings Ã— má»—i binding 5 fields = 40 symbolic variables.

**Option A â€” Full symbolic (exhaustive):**
- `kani::any()` cho má»i field, chá»‰ `kani::assume()` cho type bounds
- Pro: Chá»©ng minh máº¡nh nháº¥t â€” cover má»i tráº¡ng thÃ¡i cÃ³ thá»ƒ
- Con: Kani timeout ráº¥t cÃ³ thá»ƒ xáº£y ra cho IRQ (8 bindings) vÃ  watchdog (8 tasks)
- Giáº£m thiá»ƒu: `#[kani::unwind(9)]` + `--cbmc-args --object-bits 8`

**Option B â€” Constrained (assume invariants):**
- Giáº£ Ä‘á»‹nh invariants Ä‘Ã£ Ä‘Æ°á»£c enforce bá»Ÿi code: vÃ­ dá»¥ "má»—i INTID chá»‰ xuáº¥t hiá»‡n 1 láº§n", "task_id < NUM_TASKS"
- Pro: Cháº¡y nhanh hÆ¡n nhiá»u; váº«n chá»©ng minh Ä‘Ãºng conditional on invariants
- Con: Náº¿u invariant bá»‹ vi pháº¡m trong thá»±c táº¿, proof khÃ´ng báº¯t Ä‘Æ°á»£c

**Option C â€” Tiered (full cho grant, constrained cho irq):**
- Grant: full symbolic (MAX_GRANTS = 2 â†’ chá»‰ 10 symbolic vars â†’ tractable)
- IRQ: constrained (MAX_IRQ_BINDINGS = 8 â†’ quÃ¡ lá»›n cho full symbolic)
- Watchdog: constrained (NUM_TASKS = 8 â†’ cáº§n reduce)
- Pro: Best of both; pragmatic cho tá»«ng module
- Con: Inconsistent proof strength across modules

**Trade-offs cáº§n cÃ¢n nháº¯c:**
- Phase N dÃ¹ng `#[kani::unwind(5)]` cho IPC (MAX_WAITERS=4). IRQ cáº§n `unwind(9)`.
- Grant chá»‰ cÃ³ MAX_GRANTS=2 â€” full symbolic ráº¥t kháº£ thi.
- Kani trong aegis-dev Docker Ä‘Ã£ cháº¡y 10 proofs trong ~2 phÃºt. ThÃªm 8 proofs vá»›i full symbolic IRQ cÃ³ thá»ƒ tÄƒng lÃªn 10+ phÃºt.
- CBMC memory: `--object-bits 8` Ä‘á»§ cho arrays nhá», nhÆ°ng 8Ã—5 fields cÃ³ thá»ƒ cáº§n `--object-bits 10`.

---

### CÃ¢u há»i 3: Miri scope vÃ  KernelCell compatibility

Miri phÃ¡t hiá»‡n UB trong unsafe code nhÆ°ng cÃ³ giá»›i háº¡n quan trá»ng:

**Váº¥n Ä‘á» KernelCell:**
```rust
pub struct KernelCell<T>(UnsafeCell<T>);
impl<T> KernelCell<T> {
    pub unsafe fn get_mut(&self) -> *mut T { self.0.get() }
    pub fn get(&self) -> &T { unsafe { &*self.0.get() } }
}
```
- Miri sáº½ **flag** viá»‡c táº¡o `&mut T` vÃ  `&T` Ä‘á»“ng thá»i (aliasing violation)
- NhÆ°ng AegisOS single-core, interrupts masked â†’ thá»±c táº¿ khÃ´ng race

**Option A â€” Full Miri trÃªn táº¥t cáº£ host tests:**
- Cháº¡y toÃ n bá»™ 241+ tests qua Miri
- Pro: Maximum UB coverage
- Con: KernelCell sáº½ gÃ¢y nhiá»u false positives; cháº­m (~50x); cÃ³ thá»ƒ pháº£i disable >50% tests

**Option B â€” Miri chá»‰ cho pure function tests:**
- Chá»‰ cháº¡y Miri trÃªn ~8 pure function tests má»›i (Phase P) + cÃ¡c test khÃ´ng dÃ¹ng globals
- Pro: Zero false positives (pure functions khÃ´ng dÃ¹ng KernelCell); nhanh
- Con: Coverage háº¹p; khÃ´ng verify unsafe code hiá»‡n táº¡i

**Option C â€” Miri + KernelCell shim:**
- Táº¡o `#[cfg(miri)] impl KernelCell<T>` dÃ¹ng `RefCell<T>` (safe, Miri-friendly)
- Cháº¡y má»i test qua Miri vá»›i safe shim
- Pro: Verify logic paths Ä‘áº§y Ä‘á»§; Miri kiá»ƒm tra bounds/use-after-free
- Con: Shim semantics khÃ¡c production; thÃªm complexity; khÃ´ng verify actual unsafe code

**Option D â€” Bá» Miri, táº­p trung Kani:**
- KhÃ´ng tÃ­ch há»£p Miri trong Phase P
- DÃ¹ng thá»i gian tiáº¿t kiá»‡m Ä‘á»ƒ thÃªm Kani proofs hoáº·c tÄƒng proof strength
- Pro: ÄÆ¡n giáº£n; táº­p trung; Kani Ä‘Ã£ lÃ  formal method DO-333 compliant
- Con: Thiáº¿u abstract interpretation coverage (DO-333 Â§6.3); blog #15 khÃ´ng há»©a Miri

**Trade-offs cáº§n cÃ¢n nháº¯c:**
- DO-333 Â§6.3 recommends abstract interpretation nhÆ°ng khÃ´ng báº¯t buá»™c náº¿u Ä‘Ã£ cÃ³ model checking (Kani)
- Miri + KernelCell shim = engineering effort Ä‘Ã¡ng ká»ƒ cho benefit khÃ´ng cháº¯c cháº¯n
- Náº¿u chá»n Option D, Phase P scope giáº£m (chá»‰ P1+P2+P4) â†’ nhanh hÆ¡n, Ã­t risk hÆ¡n

---

### CÃ¢u há»i 4: Grant cleanup asymmetry â€” document hay fix?

Hiá»‡n táº¡i `grant::cleanup_task()` cÃ³ behavior khÃ¡c nhau:

```
Owner fault:  Grant = EMPTY_GRANT (zero toÃ n bá»™ â€” active=false, owner=None, peer=None)
              + unmap cáº£ owner vÃ  peer
Peer fault:   peer = None, active = false
              + chá»‰ unmap peer
              (owner field VáºªN CÃ’N, phys_addr VáºªN CÃ’N â€” nhÆ°ng active=false)
```

**Option A â€” Document as intentional (khÃ´ng sá»­a code):**
- Ghi vÃ o FM.A-7 dÆ°á»›i "Design Decisions" ráº±ng Ä‘Ã¢y lÃ  Ã½ Ä‘á»“
- Kani proof `grant_cleanup_completeness` verify behavior AS-IS
- Pro: Zero runtime changes; tÃ´n trá»ng design decision Phase J
- Con: Leftover data (owner, phys_addr) trong inactive grant â†’ potential confusion

**Option B â€” Fix: peer fault cÅ©ng zero toÃ n bá»™:**
- Sá»­a `cleanup_task()`: peer fault â†’ `GRANTS[i] = EMPTY_GRANT` (giá»‘ng owner fault)
- Pro: Consistent behavior; Kani proof Ä‘Æ¡n giáº£n hÆ¡n; no leftover data
- Con: Thay Ä‘á»•i runtime behavior â†’ risk regression; pháº£i update host tests

**Option C â€” Fix: thÃªm owner notification khi peer fault:**
- Khi peer fault, set `peer = None` nhÆ°ng giá»¯ `active = true` + thÃ´ng bÃ¡o owner qua notification
- Pro: Owner biáº¿t grant bá»‹ revoke; cÃ³ thá»ƒ re-grant cho peer khÃ¡c
- Con: Phá»©c táº¡p hÆ¡n; thÃªm syscall/notification logic; scope creep

**Trade-offs cáº§n cÃ¢n nháº¯c:**
- ISO 26262 Part 9 (DFA) yÃªu cáº§u "lá»—i á»Ÿ thÃ nh pháº§n nÃ y KHÃ”NG gÃ¢y lá»—i thÃ nh pháº§n kia" â€” cleanup asymmetry khÃ´ng vi pháº¡m náº¿u `active=false` Ä‘Ã£ ngÄƒn access
- NhÆ°ng leftover data trong inactive grant cÃ³ thá»ƒ gÃ¢y confusion náº¿u grant_id Ä‘Æ°á»£c reuse
- Option B chá»‰ cáº§n thay 2 dÃ²ng code + update 1-2 host tests

---

### CÃ¢u há»i 5: FM.A-7 proof coverage document â€” depth level?

**Option A â€” Minimal table:**
- Báº£ng 18 dÃ²ng: Module | Proof | Property | Phase
- Pro: Nhanh; dá»… maintain
- Con: KhÃ´ng Ä‘Ã¡p á»©ng Ä‘áº§y Ä‘á»§ FM.A-7 (thiáº¿u uncovered properties, assumptions, limitations)

**Option B â€” Comprehensive document:**
- Báº£ng mapping + "Uncovered Properties" backlog + "Proof Limitations & Assumptions" + "Property Classification" (safety/security/functional)
- Pro: ÄÃ¡p á»©ng FM.A-7 Ä‘áº§y Ä‘á»§; roadmap rÃµ rÃ ng cho future proofs
- Con: Tá»‘n thá»i gian; document cÃ³ thá»ƒ outdated nhanh náº¿u khÃ´ng maintain

**Option C â€” Living document + automation:**
- Comprehensive document + script tá»± extract proof list tá»« source code (`grep '#\[kani::proof\]'`)
- Pro: Self-updating; luÃ´n chÃ­nh xÃ¡c
- Con: Phá»©c táº¡p; automation script cáº§n maintain

**Trade-offs cáº§n cÃ¢n nháº¯c:**
- Blog #15 há»©a roadmap formal methods â†’ Option B phÃ¹ há»£p nháº¥t
- FM.A-7 gá»‘c yÃªu cáº§u "coverage analysis" â€” cáº§n biáº¿t proofs cover bao nhiÃªu % modules/properties
- Náº¿u chá»n Option C, script chá»‰ ~10 dÃ²ng Bash/PowerShell

---

### CÃ¢u há»i 6: README refresh scope â€” fix numbers hay rewrite?

`README.md` lá»—i thá»i á»Ÿ **nhiá»u section** (scheduler "3 tasks" â†’ 8, tests "189" â†’ 241+, memory map sai, thiáº¿u user workspace, thiáº¿u KernelCell/klog!/Exited/Kani).

**Option A â€” Minimal fixes (chá»‰ sá»­a con sá»‘):**
- Cáº­p nháº­t: 3â†’8 tasks, 18â†’19 bits, 13â†’14 syscalls, 189â†’249 tests, 25â†’32 checkpoints
- Pro: Nhanh (~30 phÃºt); Ã­t risk diff
- Con: Architecture diagram váº«n sai; source layout thiáº¿u; features list lá»—i thá»i

**Option B â€” Full rewrite Ä‘á»“ng bá»™ vá»›i copilot-instructions.md:**
- Láº¥y `.github/copilot-instructions.md` (Phase O â€” Ä‘Ã£ cáº­p nháº­t) lÃ m source of truth
- Viáº¿t láº¡i: Architecture, Memory Map, Source Layout, Features, Build, Test
- Pro: README chÃ­nh xÃ¡c 100%; consistent vá»›i copilot-instructions
- Con: Diff lá»›n (~200 dÃ²ng); review effort cao; merge conflicts náº¿u cÃ³ parallel work

**Option C â€” README lite + link to docs:**
- Sá»­a numbers + thÃªm link "Xem chi tiáº¿t táº¡i docs/" cho má»—i section
- Giá»¯ README ngáº¯n gá»n, chuyá»ƒn detail sang VitePress docs
- Pro: README maintainable lÃ¢u dÃ i; single source of truth á»Ÿ docs/
- Con: README thiáº¿u standalone value cho GitHub visitors

---

## RÃ ng buá»™c

| # | RÃ ng buá»™c | LÃ½ do |
|---|---|---|
| 1 | **Zero runtime changes** â€” Phase P khÃ´ng thay Ä‘á»•i behavior cá»§a kernel/tasks | Pure verification phase |
| 2 | **32/32 QEMU checkpoints pháº£i pass** sau má»—i sub-phase | Regression test |
| 3 | **241 existing host tests pháº£i pass** â€” khÃ´ng sá»­a/xÃ³a test hiá»‡n táº¡i | Backward compatibility |
| 4 | **No heap** â€” pure functions tráº£ fixed-size arrays/Result | AegisOS báº¥t biáº¿n |
| 5 | **TrapFrame 288B ABI-locked** â€” khÃ´ng Ä‘á»¥ng | ABI constraint |
| 6 | **Kani cháº¡y trong aegis-dev Docker** | Infrastructure constraint |
| 7 | **Capability bits: 19/64 Ä‘Ã£ dÃ¹ng** â€” Phase P khÃ´ng thÃªm syscall/cap má»›i | Scope constraint |
| 8 | **`KernelCell::get_mut()` lÃ  unsafe** â€” pure functions pháº£i nháº­n `&[T; N]` thay vÃ¬ gá»i globals | Kani requirement |
| 9 | **Kani timeout budget: â‰¤5 phÃºt per proof** trÃªn aegis-dev container | CI practicality |
| 10 | **Phase O items má»Ÿ:** #10 (Phase P roadmap âœ… Ä‘ang lÃ m) vÃ  #12 (README) pháº£i close trong Phase P | Tráº£ ná»£ |

## TiÃªu chÃ­ Ä‘Ã¡nh giÃ¡ thÃ nh cÃ´ng

| # | TiÃªu chÃ­ | Measurement |
|---|---|---|
| 1 | **â‰¥8 Kani proofs má»›i** (grant â‰¥2, irq â‰¥2, watchdog â‰¥1) | `cargo kani --tests` â†’ â‰¥18/18 pass |
| 2 | **Pure functions extracted** cho grant + irq + watchdog | Code review: pub fn trong má»—i module |
| 3 | **â‰¥8 host tests má»›i** cho pure functions | `cargo test` â†’ â‰¥249 pass |
| 4 | **32/32 QEMU checkpoints pass** (regression) | `qemu_boot_test.ps1` |
| 5 | **FM.A-7 document created** vá»›i mapping cho táº¥t cáº£ proofs | File exists, báº£ng Ä‘áº§y Ä‘á»§ |
| 6 | **README.md updated** â€” Ã­t nháº¥t fix táº¥t cáº£ con sá»‘ sai | Diff review |
| 7 | **Miri decision documented** â€” náº¿u tÃ­ch há»£p thÃ¬ CI pass; náº¿u defer thÃ¬ ghi lÃ½ do | Decision log |
| 8 | **Phase O items #10 vÃ  #12 closed** | Checklist update |
